<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>galaxy.galaxy &#8212; pyclusterevol -0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '-0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="pyclusterevol -0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyclusterevol -0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for galaxy.galaxy</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Apr 24 23:45:55 2015</span>
<span class="sd">@author: hoseung</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Galaxy object </span>
<span class="c1">#class Galaxy(halo.HaloMeta):</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Inheries halo.HaloMeta. </span>
<span class="sd">HaloMeta does not contain positional and kinematic information of the halo. </span>
<span class="sd">This is good because recalculated center of galaxy is </span>
<span class="sd">likely to deviate from the center of the halo. </span>


<span class="sd">ATTENTION!!</span>

<span class="sd">with RdYlDu color map, empty cells in the velocity map are yellow. </span>
<span class="sd">cells with no mass should be NaN, not 0. </span>
<span class="sd">Fix it</span>

<span class="sd">&quot;&quot;&quot;</span>
    
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#import  matplotlib.pyplot as plt</span>

<div class="viewcode-block" id="print_large_number"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.print_large_number">[docs]</a><span class="k">def</span> <span class="nf">print_large_number</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">q</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">e4</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">))</span></div>

<div class="viewcode-block" id="Meta"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Meta">[docs]</a><span class="k">class</span> <span class="nc">Meta</span><span class="p">():</span>   
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vxc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vyc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reff</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstar</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgas</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_r</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr2</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># reoriented values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_r2</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># reoriented values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pq</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfr</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssfr</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mrj</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d2t</span><span class="o">=</span><span class="mf">0.0</span>
        
<div class="viewcode-block" id="Meta.show_summary"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Meta.show_summary">[docs]</a>    <span class="k">def</span> <span class="nf">show_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            prints a summary of the galaxy meta data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> 
                        <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="c1"># if sequence</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">q</span><span class="p">):</span> <span class="c1"># string..</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">print_large_number</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>     </div></div>

	

<div class="viewcode-block" id="Galaxy"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy">[docs]</a><span class="k">class</span> <span class="nc">Galaxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">halo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_halo</span><span class="p">(</span><span class="n">halo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="c1">#self.meta.id=-1 # why did I do this...?? </span>

<div class="viewcode-block" id="Galaxy.set_halo"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.set_halo">[docs]</a>    <span class="k">def</span> <span class="nf">set_halo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">halo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">halo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo</span> <span class="o">=</span> <span class="n">halo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span></div>
        
<div class="viewcode-block" id="Galaxy.set_ptypes"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.set_ptypes">[docs]</a>    <span class="k">def</span> <span class="nf">set_ptypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>
   
<div class="viewcode-block" id="Galaxy.physical_print"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.physical_print">[docs]</a>    <span class="k">def</span> <span class="nf">physical_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># If length, </span>
        
        <span class="nb">print</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span></div>


<div class="viewcode-block" id="Galaxy.radial_profile_cut"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.radial_profile_cut">[docs]</a>    <span class="k">def</span> <span class="nf">radial_profile_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span>
                           <span class="n">den_lim</span><span class="o">=</span><span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="n">den_lim2</span><span class="o">=</span><span class="mi">5</span><span class="n">e6</span><span class="p">,</span>
                           <span class="n">mag_lim</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># 2D photometry. (if rotated towards +y, then use x and z)</span>
        <span class="c1"># now assuming +z alignment. </span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span><span class="c1"># in kpc unit</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>

        <span class="c1"># Account for weights.</span>
        <span class="n">i_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
        <span class="n">r_sorted</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="n">i_sort</span><span class="p">]</span>
        <span class="n">m_sorted</span> <span class="o">=</span> <span class="n">mm</span><span class="p">[</span><span class="n">i_sort</span><span class="p">]</span>

        <span class="n">rmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="n">rmax</span><span class="p">])</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rmax</span><span class="o">/</span><span class="n">dr</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">nbins</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too small size </span><span class="se">\n</span><span class="s2"> # of stars:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rr</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">frequency</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">r_sorted</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">rmax</span><span class="p">])</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dr</span> <span class="c1"># remove the rightmost boundary.</span>
        
        <span class="n">m_radial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span>
        <span class="n">ibins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">frequency</span><span class="p">)))</span>

        <span class="n">i_r_cut1</span> <span class="o">=</span> <span class="n">nbins</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Maximum value</span>
        <span class="c1"># on rare occasions, a galaxy&#39;s stellar surface density</span>
        <span class="c1"># never crosses the density limit. Then i_r_cut1 = last index.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="p">):</span>
            <span class="n">m_radial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m_sorted</span><span class="p">[</span><span class="n">ibins</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">ibins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            <span class="c1"># Check stellar surface density</span>
            <span class="n">sig_at_r</span> <span class="o">=</span> <span class="n">m_radial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">sig_at_r</span><span class="p">,</span> <span class="n">den_lim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sig_at_r</span> <span class="o">&lt;</span> <span class="n">den_lim</span><span class="p">:</span>
                <span class="n">i_r_cut1</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>
        <span class="c1">#i_r_cut2= np.argmax(m_radial/(2 * np.pi * bin_centers * dr) &lt; den_lim2)</span>
        <span class="c1"># If for some reason central region is less dense,</span>
        <span class="c1"># profile can end at the first index.</span>
        <span class="c1"># Instead coming from backward, search for the point the opposite condition satisfied.</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rmax</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bins&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ibins&quot;</span><span class="p">,</span> <span class="n">ibins</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bin centers&quot;</span><span class="p">,</span> <span class="n">bin_centers</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m_radial&quot;</span><span class="p">,</span> <span class="n">m_radial</span><span class="p">)</span>
            
        <span class="n">den_radial_inverse</span> <span class="o">=</span> <span class="n">m_radial</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bin_centers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;den_radial_inverse&quot;</span><span class="p">,</span> <span class="n">den_radial_inverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">den_radial_inverse</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">den_lim2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">i_r_cut2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">m_radial</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">den_radial_inverse</span> <span class="o">&gt;</span> <span class="n">den_lim2</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[galaxy.Galaxy.radial_profile_cut] m_radial </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">m_radial</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[galaxy.Galaxy.radial_profile_cut] den_radial_inverse </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">den_radial_inverse</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[galaxy.Galaxy.radial_profile_cut] i_r_cut2&quot;</span><span class="p">,</span> <span class="n">i_r_cut2</span><span class="p">)</span>
        
        <span class="n">mtot2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m_radial</span><span class="p">[:</span><span class="n">i_r_cut2</span><span class="p">])</span>
        <span class="n">mtot1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m_radial</span><span class="p">[:</span><span class="n">i_r_cut1</span><span class="p">])</span>
        <span class="n">i_reff2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m_sorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mtot2</span><span class="p">))</span>
        <span class="n">i_reff1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m_sorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">mtot1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff2</span> <span class="o">=</span> <span class="n">r_sorted</span><span class="p">[</span><span class="n">i_reff2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span>  <span class="o">=</span> <span class="n">r_sorted</span><span class="p">[</span><span class="n">i_reff1</span><span class="p">]</span>
        <span class="c1">#print(bin_centers, i_r_cut2, m_radial)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">i_r_cut2</span><span class="p">],</span><span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">bin_centers</span><span class="p">[</span><span class="n">i_r_cut1</span><span class="p">],</span><span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span><span class="p">])</span><span class="c1">#bin_centers[i_r_cut1]</span>

<span class="c1">#       velocity center</span>
<span class="c1">#       It is not wrong for BCGs to have very large Reff(~50kpc). </span>
<span class="c1">#       But referring the average velocity of stellar particles inside 50kpc </span>
<span class="c1">#       as the system velocity is WRONG.</span>
<span class="c1">#       If 1Reff is huge, try smaller aperture when measuring the system velocity.</span>
<span class="c1">#</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[galaxy.Galaxy.radial_profile_cut] mtot, mtot2&quot;</span><span class="p">,</span> <span class="n">mtot1</span><span class="p">,</span> <span class="n">mtot2</span><span class="p">)</span>

        <span class="n">i_close</span> <span class="o">=</span> <span class="n">i_sort</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m_sorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">mtot2</span><span class="p">))]</span> <span class="c1"># 20% closest particles</span>

       
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vx</span><span class="p">[</span><span class="n">i_close</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vy</span><span class="p">[</span><span class="n">i_close</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">i_close</span><span class="p">])</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="Galaxy.mk_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.mk_gal">[docs]</a>    <span class="k">def</span> <span class="nf">mk_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
               <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">mstar_min</span><span class="o">=</span><span class="mi">1</span><span class="n">e9</span><span class="p">,</span>
               <span class="n">rmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Rgal_to_reff</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">method_com</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">follow_bp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">unit_conversion</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Input data in code unit.</span>

<span class="sd">            Returns True if it is a &quot;good&quot; galaxy</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            </span>
<span class="sd">            Rgal_to_reff: </span>
<span class="sd">                Galaxy radius = Reff * Rgal_to_reff.</span>
<span class="sd">                By default, Rgal = 5*Reff. </span>
<span class="sd">                (E&#39;s have smaller R_t_r, L&#39;s have larger.)</span>

<span class="sd">            Notes</span>
<span class="sd">            ----- </span>
<span class="sd">            Since now (as of 2016.03) galaxy calculation is based on the GalaxyMaker results,</span>
<span class="sd">            let&#39;s just believe and minimize redundant processes to determine the center of mass,</span>
<span class="sd">            system velocity, and to check the presence of additional components. </span>

<span class="sd">            Assuming all data in the code units.</span>
<span class="sd">            </span>
<span class="sd">            dr, bin size for radial profile cut measure, scales with exponential factor.</span>
<span class="sd">            Without scaling, 0.5kpc bin size is too large for ~1kpc galaxies at high-z. </span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;Need halo information,&quot;</span>
        <span class="s2">&quot;use Galaxy.set_halo() and provide x,y,z,vx,vy,vz,r,rvir, at least&quot;</span>
        <span class="s2">&quot;Units are - &quot;</span>

        <span class="n">member</span><span class="o">=</span><span class="s2">&quot;Reff&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making a galaxy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAVE:&quot;</span><span class="p">,</span> <span class="n">save</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Halo size:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;rvir&#39;</span><span class="p">])</span>


        <span class="c1"># galaxy center from GalaxyMaker. - good enough.</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">zc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xc, yxc,zc =&quot;</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">zc</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="o">*</span><span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="o">*</span><span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">zc</span> <span class="o">=</span> <span class="n">zc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="o">*</span><span class="mi">1000</span>

            <span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="o">*</span><span class="mi">1000</span>
            <span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="o">*</span><span class="mi">1000</span>
            <span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="o">*</span><span class="mi">1000</span>
            <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">msun</span>
        <span class="k">elif</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;GM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">zc</span> <span class="o">=</span> <span class="n">zc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span>
            
            <span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e3</span>
            <span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e3</span>
            <span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">zc</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e3</span>
            <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e11</span> <span class="c1"># in Msun.</span>


        <span class="n">rgal_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rgal_tmp&quot;</span><span class="p">,</span> <span class="n">rgal_tmp</span><span class="p">)</span>
        <span class="n">dense_enough</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radial_profile_cut</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span>
                                <span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">],</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">],</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">],</span>
                                <span class="n">den_lim</span><span class="o">=</span><span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="n">den_lim2</span><span class="o">=</span><span class="mi">5</span><span class="n">e6</span><span class="p">,</span>
                                <span class="n">mag_lim</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                <span class="n">nbins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">rgal_tmp</span><span class="o">/</span><span class="mf">0.5</span><span class="p">),</span>
                                <span class="n">dr</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">aexp</span><span class="p">,</span>
                                <span class="n">rmax</span><span class="o">=</span><span class="n">rgal_tmp</span><span class="p">,</span>
                                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dense_enough</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not dense enough&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">+</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">+</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1"># in kpc unit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">star</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[galaxy.Galaxy.mk_gal] mima vx 1&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nstar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span> <span class="o">&lt;</span> <span class="n">mstar_min</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough stars: </span><span class="si">{:.2e}</span><span class="s2"> Msun&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Aborting... </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">star</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>                    

        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">Rgal_to_reff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span>
        <span class="c1"># should not surpass rr_tmp, over where another galaxy might be.</span>
        
        <span class="c1"># Test if the outer annulus has significant amount of stars</span>
        <span class="c1"># -&gt; it shouldn&#39;t.        </span>
<span class="c1">#        if verbose: print(&quot;Reff: &quot;, reff_tmp)</span>

        <span class="c1"># extract galaxy (particles and gas)</span>
        <span class="k">if</span> <span class="n">star</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nstar_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nstar tot:&quot;</span><span class="p">,</span> <span class="n">nstar_tot</span><span class="p">)</span>        
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Store stellar particle&quot;</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">and</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">utils.cosmology</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">time2gyr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                                             <span class="n">z_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">zred</span><span class="p">,</span>
                                             <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># VERY arbitrary..</span>
<span class="c1">#        self.Rgal_to_reff = 4 #rgal_tmp / reff_tmp</span>
        <span class="n">rgal_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">Rgal_to_reff</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span>

        <span class="c1">#print(&quot;.........&quot;, self.star[&#39;m&#39;][100:120], self.mstar)</span>
        <span class="kn">import</span> <span class="nn">utils.sampling</span> <span class="k">as</span> <span class="nn">smp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">set_region</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">yc</span><span class="p">,</span> <span class="n">zc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">zc</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal</span><span class="p">)</span>

        <span class="c1"># Now, get cov</span>
<span class="c1">#        self.get_cov(center_only=True)</span>
        <span class="k">if</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span>
        <span class="k">elif</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;GM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span>
      
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[galaxy.Galaxy.mk_gal] meta.v[x,y,z]c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[galaxy.Galaxy.mk_gal] mima vx 2&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">dm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">member</span> <span class="o">==</span> <span class="s2">&quot;Reff&quot;</span><span class="p">:</span>
                <span class="n">idm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">xc</span><span class="p">)</span> <span class="o">+</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">yc</span><span class="p">)</span> <span class="o">+</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">zc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">rgal_tmp</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">member</span> <span class="o">==</span> <span class="s2">&quot;v200&quot;</span><span class="p">:</span>
            <span class="c1"># Although the velocity is redefined later,</span>
            <span class="c1"># particle membership is fixed at this point. </span>
                <span class="n">idm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span><span class="p">)</span><span class="o">+</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;vy&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span><span class="p">)</span><span class="o">+</span> 
                                <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;vz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="mi">200</span><span class="o">**</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ndm_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idm</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">(</span><span class="n">ndm_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> 
            <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">msun</span>
                <span class="k">elif</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;GM&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e11</span>

            <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">elif</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;GM&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">xc</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">yc</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">zc</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e3</span>
            <span class="k">if</span> <span class="s1">&#39;vel&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                    <span class="c1"># Velocity is centered and normalized later on.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span>
                <span class="k">elif</span> <span class="n">unit_conversion</span> <span class="o">==</span> <span class="s2">&quot;GM&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DM data stored&quot;</span><span class="p">)</span>
            

        <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell is NOT none&quot;</span><span class="p">)</span>
            <span class="n">icell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">+</span> 
                             <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">+</span> 
                             <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">rgal_tmp</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ncell_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">icell</span><span class="p">)</span>
            <span class="n">dtype_cell</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">,),(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">,),(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;dx&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span> <span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span> <span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vz&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span> <span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;metal&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;f8&#39;</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">(</span><span class="n">ncell_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype_cell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var0&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var1&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var2&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var3&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var4&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;metal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var5&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_mgas</span><span class="p">()</span>
            
        <span class="c1"># Some more sophistications.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print(&quot;Rgal = 4 * Reff = &quot;, rgal_tmp * self.info.pboxsize * 1000)</span>
<span class="sd">        </span>
<span class="sd">            # Save sink particle as a BH, not cloud particles. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Galaxy.reff_main_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.reff_main_gal">[docs]</a>    <span class="k">def</span> <span class="nf">reff_main_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check for additional galaxy inside the region.</span>
<span class="sd">            If there is another galaxy, Rgal is limited to the </span>
<span class="sd">            Finally returns temporary galaxy radius.</span>
<span class="sd">            </span>
<span class="sd">          1) peaks of components are far enough.</span>
<span class="sd">          2) minor component is larger than `10%&#39; of the major component (number of stars)</span>
<span class="sd">           - second peak is also a considerable galaxy, large enough to be considered as</span>
<span class="sd">            a minor merging counter part. (or minor interaction counter part.)</span>
<span class="sd">          3) minimum value is significantly smaller than the second peak.</span>
<span class="sd">           - two galaxise are not closely connected.</span>
<span class="sd">           - minor components are not background from a larger structure. </span>
<span class="sd">             Because smooth background should not have significant peak.</span>
<span class="sd">             Or, a background with significant peak would be the host galaxy of this galaxy.</span>
<span class="sd">             If that is the case, this galaxy should not be identified as a &#39;main&#39; galaxy,</span>
<span class="sd">             and accounting for embeded satellites is another thing. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_find_maxima</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">exclude_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Return indices of points that has larger values than neighbouring points</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exclude_end</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">def</span> <span class="nf">_find_minima</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">exclude_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Return indices of points that has smaller values than neighbouring points</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exclude_end</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">def</span> <span class="nf">_smooth</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box_pts</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Smooth array by convolution. (Center shift)</span>
<span class="sd">                </span>
<span class="sd">                Parameters</span>
<span class="sd">                ----------</span>
<span class="sd">                box_pts : int</span>
<span class="sd">                    size of convolution box</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">box_pts</span><span class="p">)</span><span class="o">/</span><span class="n">box_pts</span>
            <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">y_smooth</span>   

        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">nbins</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))[</span><span class="n">_find_maxima</span><span class="p">(</span><span class="n">_smooth</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">exclude_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="c1"># Because I don&#39;t allow the first bin be a maximum, the number of bins</span>
        <span class="c1"># must be large enough so that the main galaxy is divided by enough bins.</span>
        <span class="c1"># With too few bins, the first bin, covering most of the galaxy by itself,</span>
        <span class="c1"># may have the largest number of particles. </span>
        
        <span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))[</span><span class="n">_find_minima</span><span class="p">(</span><span class="n">_smooth</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">exclude_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

        <span class="c1"># If there is no second component, imin3 =[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imin</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No second component.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Good to go!, Calcualte R_gal with all the particles&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span> <span class="c1">#self.get_radius(xx, yy, zz, mm, self.radius_method)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnt_major</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">imin</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">cnt_minor</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">imin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">imax</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">f_mM</span> <span class="o">=</span> <span class="n">cnt_minor</span><span class="o">/</span><span class="n">cnt_major</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;particle number fraction, #star_Minor/#star_Major:&quot;</span><span class="p">,</span> <span class="n">f_mM</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_mM</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There is another galaxy at </span><span class="si">{:.2f}</span><span class="s2">kpc from the center.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">imax</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suggested R_gal &lt; </span><span class="si">{:.2f}</span><span class="s2">kpc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">imin</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="k">return</span> <span class="n">bins</span><span class="p">[</span><span class="n">imin</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Galaxy.get_radius"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.get_radius">[docs]</a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method 1: Radius = Rvir_halo</span>
<span class="sd">            Method 2: Radius = half mass radius of given stellar particles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;rvir&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;eff&quot;</span><span class="p">:</span>
            <span class="c1"># requires galaxy center to be determined. </span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">zz</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
            <span class="n">r_again</span> <span class="o">=</span> <span class="n">dmax</span>
            <span class="n">m_annuli</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">nbin</span><span class="o">=</span><span class="mi">8</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
                <span class="n">m_annuli</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="n">mm</span><span class="p">[(</span><span class="n">dd</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dmax</span><span class="o">/</span><span class="n">nbin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dmax</span><span class="o">/</span><span class="n">nbin</span><span class="p">)]))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m_annuli</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m_annuli</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">r_again</span> <span class="o">=</span> <span class="n">dmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nbin</span>
                    <span class="k">break</span>
            <span class="n">i_again</span> <span class="o">=</span> <span class="n">dd</span> <span class="o">&lt;</span> <span class="n">r_again</span>
            <span class="n">dsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">i_again</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mm</span><span class="p">[</span><span class="n">i_again</span><span class="p">]</span>
            <span class="c1"># half-mass radius, not half-particle radius.</span>
            <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">dsort</span><span class="p">])</span>

            <span class="n">ihalf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumsum</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># If two galaxies are merging, </span>
            <span class="c1"># Chances are cumsum has a flat interval. </span>
            <span class="c1"># If there is such anormaly, measure Reff again by</span>
            <span class="c1"># shirinking the radius a bit.</span>
            <span class="n">reff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">i_again</span><span class="p">][</span><span class="n">dsort</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]])</span>
            <span class="c1"># Rough profile</span>

            <span class="k">return</span> <span class="n">reff</span></div>

<div class="viewcode-block" id="Galaxy.get_center"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.get_center">[docs]</a>    <span class="k">def</span> <span class="nf">get_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the center of mass of given particles.</span>
<span class="sd">        IDL version iteratively searches for mass weighted mean position of</span>
<span class="sd">        particles within gradually decreasing search radius. </span>
<span class="sd">        Let&#39;s do the same thing here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">/</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># 10kpc/h</span>
        <span class="c1"># Stops if r &lt; 10pc</span>
        <span class="c1"># or, if dx_3d &lt; 5 pc</span>
        <span class="n">msum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">xc_old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
        <span class="n">yc_old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
        <span class="n">zc_old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
    
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>    
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niter</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="p">:</span>
            
            <span class="n">msum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
            <span class="n">yc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
            <span class="n">zc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
            
            <span class="n">dx3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xc_old</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yc_old</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">zc_old</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dx3</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span>
                <span class="k">break</span>
    
            <span class="c1"># shrink the search radius by half.</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    
            <span class="n">r</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">ptp</span><span class="p">()])</span>
    
            <span class="n">xc_old</span> <span class="o">=</span> <span class="n">xc</span>
            <span class="n">yc_old</span> <span class="o">=</span> <span class="n">yc</span>
            <span class="n">zc_old</span> <span class="o">=</span> <span class="n">zc</span>
            
            <span class="n">i</span> <span class="o">+=</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">zc</span></div>

        
<div class="viewcode-block" id="Galaxy.get_center2"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.get_center2">[docs]</a>    <span class="k">def</span> <span class="nf">get_center2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mf">1.0</span>        
        <span class="k">def</span> <span class="nf">_ind2pos</span><span class="p">(</span><span class="n">i_this</span><span class="p">,</span> <span class="n">ptp</span><span class="p">,</span> <span class="n">dims</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i_this</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ptp</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">i_this</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ptp</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">i_this</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ptp</span>
        
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>
        
        <span class="k">def</span> <span class="nf">_normalize</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Normalize an array into 0 &lt;= array &lt; 1.0</span>
<span class="sd">                by dividing by the array.ptp() and then </span>
<span class="sd">                moving the element with maximum value inside.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>

        
        <span class="k">def</span> <span class="nf">_get_dpeak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">assign</span>
            <span class="n">ptp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">ptp</span><span class="p">()])</span>

            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">ptp</span> <span class="o">*</span> <span class="n">npix</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">ptp</span> <span class="o">*</span> <span class="n">npix</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="n">ptp</span> <span class="o">*</span> <span class="n">npix</span>
            
<span class="c1">#            print(x.min(),x.max(),y.min(),y.max(),z.min(),z.max())            </span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">assign</span><span class="o">.</span><span class="n">cic</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span>
                               <span class="n">y</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span>
                               <span class="n">npix</span><span class="p">,</span> <span class="n">wraparound</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm_integer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">i_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="c1"># </span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">i_peak</span> <span class="o">//</span> <span class="p">(</span><span class="n">npix</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">i_peak</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">npix</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span><span class="o">//</span><span class="n">npix</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">i_peak</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">npix</span><span class="o">*</span><span class="n">npix</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">npix</span>
            <span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span><span class="p">,</span> <span class="n">znew</span> <span class="o">=</span><span class="n">_ind2pos</span><span class="p">([</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">],</span> <span class="n">ptp</span><span class="p">,</span> <span class="p">[</span><span class="n">npix</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">xnew</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">xnew</span>
            <span class="n">ynew</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">ynew</span>
            <span class="n">znew</span> <span class="o">=</span> <span class="n">zmin</span> <span class="o">+</span> <span class="n">znew</span>
        
            <span class="k">return</span> <span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span><span class="p">,</span> <span class="n">znew</span><span class="p">,</span> <span class="n">dx</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
            <span class="n">xc_new</span><span class="p">,</span> <span class="n">yc_new</span><span class="p">,</span> <span class="n">zc_new</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">_get_dpeak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">npix</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">xc_new</span><span class="p">,</span> <span class="n">yc_new</span><span class="p">,</span> <span class="n">zc_new</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xc_new</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yc_new</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">zc_new</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>    
  
        <span class="k">return</span> <span class="n">xc_new</span><span class="p">,</span> <span class="n">yc_new</span><span class="p">,</span> <span class="n">zc_new</span></div>


<div class="viewcode-block" id="Galaxy.e_vdiff"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.e_vdiff">[docs]</a>    <span class="k">def</span> <span class="nf">e_vdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">vxt</span><span class="p">,</span> <span class="n">vyt</span><span class="p">,</span> <span class="n">vzt</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">vxt</span> <span class="o">-</span> <span class="n">vxt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">vyt</span> <span class="o">-</span> <span class="n">vyt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">vzt</span> <span class="o">-</span> <span class="n">vzt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">vdiff</span><span class="p">[</span><span class="n">vdiff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span></div>
    

<div class="viewcode-block" id="Galaxy.get_cov"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.get_cov">[docs]</a>    <span class="k">def</span> <span class="nf">get_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multithreaded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">if</span> <span class="n">center_only</span><span class="p">:</span>
            <span class="c1"># It is especially important when making galaxies</span>
            <span class="c1"># based on GalaxyMaker output because GalaxyMaker output</span>
            <span class="c1"># tends to be irregular.</span>
            <span class="c1"># Galaxies can have long tails. </span>
            <span class="c1"># So you need to consider only particles </span>
            <span class="c1"># near the main body of the galaxy.</span>
            <span class="c1">#</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
                          <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
                          <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span> <span class="p">)</span>

            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>

        <span class="n">vhalx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
        <span class="n">vhaly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
        <span class="n">vhalz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
        
        <span class="n">r_frac</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">vrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vx</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vy</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vz</span><span class="p">)])</span> <span class="o">*</span> <span class="mi">3</span>
        
        <span class="n">vind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vx</span> <span class="o">-</span> <span class="n">vhalx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                        <span class="p">(</span><span class="n">vy</span> <span class="o">-</span> <span class="n">vhaly</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">vz</span> <span class="o">-</span> <span class="n">vhalz</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">r_frac</span> <span class="o">*</span> <span class="n">vrange</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">npart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vind</span><span class="p">)</span>        
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;com&quot;</span>
        <span class="n">vxt</span> <span class="o">=</span> <span class="n">vhalx</span>
        <span class="n">vyt</span> <span class="o">=</span> <span class="n">vhaly</span>
        <span class="n">vzt</span> <span class="o">=</span> <span class="n">vhalz</span>
        <span class="c1"># Add adaptivity</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mostbound&quot;</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">npart</span> <span class="o">&gt;</span> <span class="mi">80000</span><span class="p">:</span>
                <span class="n">r_frac</span> <span class="o">*=</span> <span class="mf">0.7</span>
                <span class="n">vind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vx</span> <span class="o">-</span> <span class="n">vxt</span><span class="p">)</span> <span class="o">+</span> 
                    <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vy</span> <span class="o">-</span> <span class="n">vyt</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vz</span> <span class="o">-</span> <span class="n">vzt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">r_frac</span> <span class="o">*</span> <span class="n">vrange</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">npart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vind</span><span class="p">)</span>
            <span class="n">vind</span> <span class="o">=</span> <span class="n">vind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">npart</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
<span class="c1"># sparsely selected representative particles.</span>
            <span class="n">vxt</span> <span class="o">=</span> <span class="n">vx</span><span class="p">[</span><span class="n">vind</span><span class="p">]</span>
            <span class="n">vyt</span> <span class="o">=</span> <span class="n">vy</span><span class="p">[</span><span class="n">vind</span><span class="p">]</span>
            <span class="n">vzt</span> <span class="o">=</span> <span class="n">vz</span><span class="p">[</span><span class="n">vind</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
            <span class="c1"># this takes ~ 30s. with roughly the same number of particles. </span>
            <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vxt</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">vdiff</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vxt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">vxt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span> <span class="o">+</span> 
                              <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vyt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">vyt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span> <span class="o">+</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vzt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">vzt</span><span class="p">[</span><span class="n">iv</span><span class="p">]))</span>
                <span class="n">e</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">vdiff</span><span class="p">[</span><span class="n">vdiff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    
<span class="c1"># N parts that are most bound to &lt;50000 &#39;central&#39; particle group.</span>
            <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">npart</span><span class="p">)]</span>
            
            <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">vind</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vxt</span><span class="p">[</span><span class="n">emin</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="n">emin</span><span class="p">])</span> <span class="c1"># top 100 </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vyt</span><span class="p">[</span><span class="n">emin</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="n">emin</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vzt</span><span class="p">[</span><span class="n">emin</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="n">emin</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;com&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_center</span><span class="p">(</span>
                                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span></div>

<div class="viewcode-block" id="Galaxy.cal_mgas"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_mgas">[docs]</a>    <span class="k">def</span> <span class="nf">cal_mgas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">msun</span> <span class="o">=</span> <span class="mf">1.98892e33</span> <span class="c1"># solar mass in gram.</span>
        <span class="n">kpc_in_cm</span> <span class="o">=</span> <span class="mf">3.086e21</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mgas</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">unit_d</span><span class="p">)</span> <span class="o">*</span> 
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span>  <span class="o">*</span> <span class="n">kpc_in_cm</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">msun</span></div>
        <span class="c1"># [g/cm^3] * [cm^3] / [g/msun] = [msun]</span>
    
<div class="viewcode-block" id="Galaxy.cal_sfr"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_sfr">[docs]</a>    <span class="k">def</span> <span class="nf">cal_sfr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utils</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="c1"># average over last 100Myrs</span>
        <span class="n">time_new</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># in Myr</span>
        <span class="n">ind_new_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">time2gyr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">z_now</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">zred</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">time_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m_star_new</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind_new_star</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sfr</span><span class="o">=</span><span class="n">m_star_new</span> <span class="o">/</span> <span class="n">time_new</span>
        <span class="k">return</span> <span class="n">m_star_new</span> <span class="o">/</span> <span class="n">time_new</span></div>
    
<div class="viewcode-block" id="Galaxy.cal_ssfr"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_ssfr">[docs]</a>    <span class="k">def</span> <span class="nf">cal_ssfr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sfr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_sfr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ssfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sfr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span></div>

<div class="viewcode-block" id="Galaxy.cal_vrot"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_vrot">[docs]</a>    <span class="k">def</span> <span class="nf">cal_vrot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#d = np.sqrt(self.star[&#39;x&#39;]**2 +self.star[&#39;y&#39;]**2 +self.star[&#39;z&#39;]**2)</span>
        <span class="c1">#dsort = np.sort(d)    </span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Galaxy.dist_map"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.dist_map">[docs]</a>    <span class="k">def</span> <span class="nf">dist_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">npix</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">npix</span>
        
        <span class="n">dist_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="n">dist_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">j</span> <span class="o">-</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist_map</span></div>

<div class="viewcode-block" id="Galaxy.weighted_std"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.weighted_std">[docs]</a>    <span class="k">def</span> <span class="nf">weighted_std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the weighted average and standard deviation.</span>
<span class="sd">    </span>
<span class="sd">        values, weights -- Numpy ndarrays with the same shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">values</span><span class="o">-</span><span class="n">average</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># Fast and numerically precise</span>
           
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_pseudo_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">mm</span><span class="p">,</span><span class="n">vz</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_times</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sig</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">sig</span><span class="p">]]</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cov</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_times</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">n_times</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx</span>
            <span class="n">ynew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">n_times</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="n">n_times</span><span class="p">)</span><span class="o">/</span><span class="n">n_times</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">vz</span><span class="p">,</span><span class="n">n_times</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">vz</span>

<div class="viewcode-block" id="Galaxy.cal_lambda_r_eps"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_lambda_r_eps">[docs]</a>    <span class="k">def</span> <span class="nf">cal_lambda_r_eps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">npix_per_reff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                         <span class="n">rscale</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ellip&#39;</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">galaxy_plot_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
                         <span class="n">n_pseudo</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">voronoi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">save_result</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">iterate_mge</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">mge_interpol</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>


        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        npix: int</span>
<span class="sd">            number of points per 2*reff.</span>
<span class="sd">        r:</span>
<span class="sd">            ??</span>
<span class="sd">        rscale:</span>
<span class="sd">            Lambda_r is calculated for annuli up to Reff*rscale.</span>
<span class="sd">        </span>
<span class="sd">        Calculate rotation parameter(lambda_r).</span>
<span class="sd">        rotation parameter is calculated at all points (r &lt; rscale*self.reff)</span>
<span class="sd">        constructing a curve. But only the value at 0.5Reff is used as </span>
<span class="sd">        a representative value (Emsellem + 07).</span>
<span class="sd">        Values at r = 1.0 Reff is reported to behave similar to the value at 0.5Reff.</span>
<span class="sd">        </span>
<span class="sd">        Fixed number of pixels for all galaxies.</span>
<span class="sd">        boxsize = rscale * Reff * 2</span>
<span class="sd">        dx = Reff / npix</span>
<span class="sd">        npix_all = npix * rscale</span>
<span class="sd">        </span>
<span class="sd">        method1:</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        method2:</span>
<span class="sd">        </span>
<span class="sd">        MGE parameters</span>
<span class="sd">        iterate_mge : run MGE with various light fraction</span>
<span class="sd">                      to find out half light radius.</span>
<span class="sd">        mge_interpol : from iterative measruements of MGE, </span>
<span class="sd">                       interpolate quantities at the half light radius.</span>
<span class="sd">                       It&#39;s better to interpolate when iterate_mge = True.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span> 

        <span class="c1"># already centered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span> <span class="o">=</span> <span class="n">rscale</span>
            
        <span class="n">reff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span> 
        <span class="c1"># reff restriction must be given at earlier stage, radial_profile_cut()</span>
        <span class="n">r_img_kpc</span> <span class="o">=</span> <span class="n">reff</span> <span class="o">*</span> <span class="p">(</span><span class="n">rscale</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> 
        <span class="c1"># in kpc</span>
        <span class="c1"># Some margin makes mmap and vmap look better.</span>
        <span class="c1"># If rscale = 3 is given, calculate inside 3Reff,</span>
        <span class="c1"># but plot a map of 4Reff.</span>
        
        <span class="n">dx</span> <span class="o">=</span> <span class="n">reff</span> <span class="o">/</span> <span class="n">npix_per_reff</span> <span class="c1"># kpc/pixel        </span>
        <span class="n">npix</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">npix_per_reff</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">rscale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> 
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npix</span>
        <span class="c1"># to suppress contamination from tidal tail, </span>
        <span class="c1"># give a cylindrical cut, not spherical cut. </span>
        <span class="c1"># Cappellari 2002 assumes Cylindrical velocity ellipsoid.</span>
        <span class="c1"># particles inside 4Reff.</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">+</span> \
               <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">reff</span> <span class="o">*</span> <span class="p">(</span><span class="n">rscale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">n_frac</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nstar</span><span class="o">*</span><span class="mi">100</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}% o</span><span class="s2">f stellar particles selected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_frac</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_frac</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too few stars are selected. Check:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min max x&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min max y&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;min max z&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# star&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># 100% means that the galaxy radius is smaller than 4Reff.</span>
        <span class="c1"># Considering ellipticity, even 4Reff may not be enough to derive.</span>

        <span class="k">if</span> <span class="n">n_pseudo</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># sig in kpc unit. up to 1M particles</span>
            <span class="c1"># sig = 0.3kpc from Naab 2014.</span>
            <span class="n">n_pseudo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nstar</span><span class="p">),</span> <span class="n">n_pseudo</span><span class="p">])</span>
            <span class="n">xstars</span><span class="p">,</span> <span class="n">ystars</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_particles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">],</span>
                                                      <span class="n">sig</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                                                      <span class="n">n_times</span><span class="o">=</span><span class="n">n_pseudo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xstars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">ystars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="s2">&quot;Calculating Lambda_r using </span><span class="si">{}</span><span class="s2"> particles &quot;</span> 
        <span class="s2">&quot;inside </span><span class="si">{:.3f}</span><span class="s2">kpc, or </span><span class="si">{}</span><span class="s2">Reff&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">),</span> <span class="n">r_img_kpc</span><span class="p">,</span> <span class="n">rscale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    
<span class="c1">#</span>
<span class="c1"># 1. Construct mass map, velocity map, sigma map.</span>
<span class="c1">#</span>
        <span class="c1"># using NGP charge assignment</span>
        <span class="c1"># fix center explicitely.</span>
        <span class="c1"># 0.5 * (min + max) != center</span>
        <span class="n">xstars</span> <span class="o">=</span> <span class="p">(</span><span class="n">xstars</span> <span class="o">+</span> <span class="n">r_img_kpc</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_img_kpc</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nx</span> <span class="c1"># 0 &lt; xstarts &lt; nx</span>
        <span class="n">ystars</span> <span class="o">=</span> <span class="p">(</span><span class="n">ystars</span> <span class="o">+</span> <span class="n">r_img_kpc</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_img_kpc</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="c1"># because of Gaussian smoothing, pseudo particles can go out of cic region.</span>
        <span class="c1"># But don&#39;t worry, np.clip is ready.</span>
        
        <span class="c1"># NGP assignment</span>
        <span class="n">ngx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">xstars</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
        <span class="n">ngy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">ystars</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx</span> <span class="o">+</span> <span class="n">ngy</span> <span class="o">*</span> <span class="n">nx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># Mass map</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># should cover 4Reff.</span>
        <span class="k">if</span> <span class="n">voronoi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">count_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                <span class="n">count_map</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                <span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">mmap</span> <span class="o">=</span> <span class="n">mmap</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        
        <span class="c1"># Velocity and dispersion map</span>
        <span class="n">vmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sigmap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">voronoi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">count_map</span><span class="p">)</span>
            <span class="n">noise_map</span><span class="p">[</span><span class="n">noise_map</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># minimum noise for empty pixeles</span>
 
            <span class="n">xpos_regular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">ypos_regular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">nx</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">Cappellari.voronoi.voronoi_2d_binning</span> <span class="k">import</span> <span class="n">voronoi_2d_binning</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This function accepts only data on uniform grid...?</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">binNum</span><span class="p">,</span> <span class="n">xNode</span><span class="p">,</span> <span class="n">yNode</span><span class="p">,</span> <span class="n">xBar</span><span class="p">,</span> <span class="n">yBar</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">nPixels</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> \
                <span class="n">voronoi_2d_binning</span><span class="p">(</span><span class="n">xpos_regular</span><span class="p">,</span> <span class="n">ypos_regular</span><span class="p">,</span> <span class="n">count_map</span><span class="p">,</span>
                                 <span class="n">noise_map</span><span class="p">,</span> <span class="n">targetSN</span><span class="o">=</span><span class="n">voronoi</span><span class="p">[</span><span class="s2">&quot;targetSN&quot;</span><span class="p">],</span>
                                 <span class="n">plot</span><span class="o">=</span><span class="n">voronoi</span><span class="p">[</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span> <span class="n">quiet</span><span class="o">=</span><span class="n">voronoi</span><span class="p">[</span><span class="s2">&quot;quiet&quot;</span><span class="p">])</span>


            <span class="k">def</span> <span class="nf">_display_pixels</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">pixelSize</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Display pixels at coordinates (x, y) coloured with &quot;counts&quot;.</span>
<span class="sd">                This routine is fast but not fully general as it assumes the spaxels</span>
<span class="sd">                are on a regular grid. This needs not be the case for Voronoi binning.</span>
<span class="sd">            </span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">nx</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">ny</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># use nan for missing data</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">img</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
            
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;prism&#39;</span><span class="p">,</span>
                           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">pixelSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">pixelSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                   <span class="n">ymin</span> <span class="o">-</span> <span class="n">pixelSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">pixelSize</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
           
                                                         
            <span class="n">mmap_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xNode</span><span class="p">))</span>
            <span class="n">vmap_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xNode</span><span class="p">))</span> <span class="c1"># Not actually maps, but 1-D arrays.</span>
            <span class="n">sigmap_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xNode</span><span class="p">))</span>

            <span class="c1"># Quantities in Voronoi bin</span>
            <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xNode</span><span class="p">)):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binNum</span> <span class="o">==</span> <span class="n">ibin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># pixels in this Voronoi bin</span>
                <span class="n">i_part</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">:</span>
                    <span class="n">i_part</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_part</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">j</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># all particles belonging to one Voronoi cell</span>
                <span class="n">mmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mm</span><span class="p">[</span><span class="n">i_part</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">i_part</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="n">i_part</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                     <span class="k">continue</span> <span class="c1"># </span>
 
                <span class="c1"># mass-weighted sigma</span>
                <span class="n">sigmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_std</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">i_part</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="n">i_part</span><span class="p">])</span>

                <span class="c1"># update original map too.</span>
                <span class="n">vmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span>
                <span class="n">sigmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span>

            <span class="n">lambdamap_v</span> <span class="o">=</span> <span class="n">vmap_v</span> <span class="o">/</span> <span class="n">sigmap_v</span>

            <span class="n">mmap_org</span> <span class="o">=</span> <span class="n">mmap</span> 
            <span class="n">vmap_org</span> <span class="o">=</span> <span class="n">vmap</span> 
            <span class="n">sigmap_org</span> <span class="o">=</span> <span class="n">sigmap</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigmap_org</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="o">=</span> <span class="n">vmap_org</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xNode</span><span class="p">)):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binNum</span> <span class="o">==</span> <span class="n">ibin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vmap_org</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span>
                <span class="n">sigmap_org</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span>

            <span class="c1"># update maps.</span>
            <span class="c1"># keep oroginal mmap to draw plots</span>
            <span class="c1"># Don&#39;t worry.  it&#39;s just switching pointer. No memory copy.</span>
            <span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigmap_v</span>
            <span class="n">vmap</span> <span class="o">=</span> <span class="n">vmap_v</span> <span class="c1"># overwrite??</span>
            <span class="n">mmap</span> <span class="o">=</span> <span class="n">mmap_v</span>          

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No Voronoi tessellation.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># mass-weighted sigma</span>
                    <span class="n">sigmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_std</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">mm</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                    <span class="c1"># mass-weighted velocity</span>
                    <span class="n">vmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">mm</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sigmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">vmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">xNode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">ny</span><span class="p">)</span> <span class="c1"># x = tile? or repeat? </span>
            <span class="n">yNode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">nx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="o">=</span> <span class="n">vmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># 2. calculate profile over radial bins.</span>
<span class="c1"># iterate_mge : run MGE with various light fraction</span>
<span class="c1">#               to find out half light radius.</span>
<span class="c1"># mge_interpol : from iterative measruements of MGE, </span>
<span class="c1">#                interpolate quantities at the half light radius.</span>


        <span class="n">mmap_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">xNode</span> <span class="o">-</span> <span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yNode</span> <span class="o">-</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ellip&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">Cappellari</span> <span class="k">import</span> <span class="n">mge</span>
            <span class="k">if</span> <span class="n">iterate_mge</span><span class="p">:</span>
                <span class="n">eps_arr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mjr_arr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">pa_arr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">xpos_arr</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">ypos_arr</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">f_light_arr</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    <span class="c1"># mmap = 1D, self.mmap = mmap.reshap(nx,ny)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">mge</span><span class="o">.</span><span class="n">find_galaxy</span><span class="o">.</span><span class="n">find_galaxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">mask_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">fraction</span><span class="o">=</span><span class="mf">0.04</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span>
                    <span class="n">mjr_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">)</span><span class="c1">#f.majoraxis * 3.5 / npix * l_img</span>
                    <span class="n">eps_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
                    <span class="n">pa_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>
                    <span class="n">xpos_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">xmed</span><span class="p">)</span>
                    <span class="n">ypos_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">ymed</span><span class="p">)</span>
                    <span class="n">sma</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">majoraxis</span><span class="c1"># * 3.5</span>
                    <span class="n">smi</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
 
                    <span class="n">pa_rad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">theta</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="n">cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa_rad</span><span class="p">)</span>
                    <span class="n">sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa_rad</span><span class="p">)</span>

                    <span class="n">f_light_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[((</span><span class="n">xNode</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">xmed</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span> <span class="o">+</span> <span class="p">(</span><span class="n">yNode</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">ymed</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sma</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                                            <span class="p">((</span><span class="n">yNode</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">ymed</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span> <span class="o">-</span> <span class="p">(</span><span class="n">xNode</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">xmed</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">smi</span><span class="o">**</span><span class="mi">2</span> \
                                            <span class="o">&lt;</span> <span class="mf">3.5</span><span class="p">])</span><span class="o">/</span> <span class="n">mmap_tot</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reff = half light?, mjr, epss&quot;</span><span class="p">,</span> <span class="n">f_light_arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">f</span><span class="o">.</span><span class="n">majoraxis</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

    <span class="c1"># Determine eps, pa, sma, xcen, ycen</span>
                <span class="k">if</span> <span class="n">mge_interpol</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">interpol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
                         <span class="n">ind</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x0</span><span class="p">)])</span>
                         <span class="n">xl</span><span class="p">,</span> <span class="n">xr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                         <span class="n">fl</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">xl</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xr</span><span class="o">-</span><span class="n">xl</span><span class="p">)</span>
                         <span class="n">fr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xr</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xr</span><span class="o">-</span><span class="n">xl</span><span class="p">)</span>
             
                         <span class="k">return</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">ind</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">fl</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">]</span>
    
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">xcen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ycen</span> <span class="o">=</span> \
                        <span class="n">interpol</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_light_arr</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="n">eps_arr</span><span class="p">,</span> <span class="n">pa_arr</span><span class="p">,</span> <span class="n">mjr_arr</span><span class="p">,</span> <span class="n">xpos_arr</span><span class="p">,</span> <span class="n">ypos_arr</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eps arra&#39;</span><span class="p">,</span> <span class="n">eps_arr</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;interpolated eps, pa, sma, xcen, ycen&quot;</span><span class="p">,</span> \
                          <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">xcen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">ycen</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">smi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
    
                <span class="k">else</span><span class="p">:</span>              
                    <span class="n">i_reff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_light_arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="c1"># first element &gt; 0.5 -1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps_arr</span><span class="p">[</span><span class="n">i_reff</span><span class="p">]</span> <span class="c1"># eps at 1 * R_half(=eff)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">pa</span>  <span class="o">=</span> <span class="n">pa_arr</span><span class="p">[</span><span class="n">i_reff</span><span class="p">]</span>
                    <span class="n">sma</span> <span class="o">=</span> <span class="n">reff</span><span class="c1"># / np.sqrt(1-self.meta.eps) / dx </span>
                    <span class="c1"># sma becomes too large with large e, (when e = 0.9, sma = 10 * reff).</span>
                    <span class="n">smi</span> <span class="o">=</span> <span class="n">sma</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sma</span> <span class="o">=</span> <span class="n">mjr_arr</span><span class="p">[</span><span class="n">i_reff</span><span class="p">]</span> <span class="o">*</span> <span class="mf">3.5</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">smi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">sma</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
                    <span class="c1">#xcen = xpos_arr[i_reff]</span>
                    <span class="c1">#ycen = ypos_arr[i_reff]</span>
                    <span class="c1">#sma=mjr_arr[i_reff] * 0.5 * 3.5 # SEMI major axis, pixel unit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># MGE at one go.</span>
            
                <span class="c1"># mmap = 1D, self.mmap = mmap.reshap(nx,ny)</span>
                <span class="k">def</span> <span class="nf">_measure_lambda</span><span class="p">(</span><span class="n">mge_par</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">xcen</span><span class="o">=</span><span class="n">mge_par</span><span class="p">[</span><span class="s2">&quot;xcen&quot;</span><span class="p">]</span>
                    <span class="n">ycen</span><span class="o">=</span><span class="n">mge_par</span><span class="p">[</span><span class="s2">&quot;ycen&quot;</span><span class="p">]</span>
                    <span class="n">cos</span><span class="o">=</span><span class="n">mge_par</span><span class="p">[</span><span class="s2">&quot;cos&quot;</span><span class="p">]</span>
                    <span class="n">sin</span><span class="o">=</span><span class="n">mge_par</span><span class="p">[</span><span class="s2">&quot;sin&quot;</span><span class="p">]</span>
                    <span class="n">sma</span><span class="o">=</span><span class="n">mge_par</span><span class="p">[</span><span class="s2">&quot;sma&quot;</span><span class="p">]</span>
                    <span class="n">smi</span><span class="o">=</span><span class="n">mge_par</span><span class="p">[</span><span class="s2">&quot;smi&quot;</span><span class="p">]</span>
                    <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">xNode</span><span class="o">-</span><span class="n">xcen</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span> <span class="o">+</span> <span class="p">(</span><span class="n">yNode</span><span class="o">-</span><span class="n">ycen</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sma</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                                 <span class="p">((</span><span class="n">yNode</span><span class="o">-</span><span class="n">ycen</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span> <span class="o">-</span> <span class="p">(</span><span class="n">xNode</span><span class="o">-</span><span class="n">xcen</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">smi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> \
                                 <span class="n">npix_per_reff</span>
                    <span class="c1"># lambda calculaed over &#39;3&#39;Reff.</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">npix_per_reff</span> <span class="o">*</span> <span class="n">rscale</span><span class="p">))</span>
   
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reff = half light?1&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">dd</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">])</span><span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">))</span>
                    <span class="n">dist1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">xNode</span> <span class="o">-</span> <span class="n">xcen</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">yNode</span> <span class="o">-</span> <span class="n">ycen</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
<span class="c1">#                        ind = np.where( (dd &gt; i/reff) &amp; (dd &lt; (i+1)/reff))[0]</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                            
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">dist1d</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sigmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">b</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">dist1d</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span> 
                                        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vmap</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigmap</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="c1">#                                b = sum(mmap[ind] * dist1d[ind] </span>
<span class="c1">#                                    * np.sqrt(np.square(vmap[ind]) + np.square(sigmap[ind])))</span>
                                <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>


                    <span class="k">if</span> <span class="n">voronoi</span> <span class="o">==</span> <span class="mi">12312312435</span><span class="p">:</span>
                        <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xNode</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yNode</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span>\
                             <span class="n">npix_per_reff</span>
                        <span class="n">i_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">new_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">new_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># NGP, Average</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i_radius</span><span class="p">):</span>
                            <span class="n">new_arr</span><span class="p">[</span><span class="n">i_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_arr</span><span class="p">[</span><span class="n">i_r</span><span class="p">]</span> <span class="o">+</span> <span class="n">lambdamap_v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">new_cnt</span><span class="p">[</span><span class="n">i_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cnt</span><span class="p">[</span><span class="n">i_r</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                    
                    <span class="c1"># npix * npix map for plots</span>
                        <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xNode</span><span class="p">)):</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">binNum</span> <span class="o">==</span> <span class="n">ibin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">vmap_org</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span>
                            <span class="n">sigmap_org</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmap_v</span><span class="p">[</span><span class="n">ibin</span><span class="p">]</span>
                    
                        <span class="c1">#fig.suptitle(&quot;ID: {}    z: {:2f}&quot;.format(str(self.meta.id).zfill(5),</span>
                                         <span class="c1">#self.info.zred))</span>
   
<span class="c1">#### St St St Stellar particle density map</span>
                        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mmap_org</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">vmap_org</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sigmap_org</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">),</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_arr</span> <span class="o">/</span> <span class="n">new_cnt</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
   
                    <span class="k">return</span> <span class="n">points</span>        

<span class="c1">#</span>
<span class="c1"># Multiple choices for where to measure ellipticity. </span>
<span class="c1"># I need a list of MGE outputs.</span>
<span class="c1">#                </span>
                <span class="k">def</span> <span class="nf">get_mge_out</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">npix_per_reff</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">sma</span> <span class="o">=</span> <span class="n">npix_per_reff</span>
                    <span class="n">pa_rad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">theta</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="k">return</span> <span class="nb">dict</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                                 <span class="s2">&quot;frac&quot;</span><span class="p">:</span><span class="n">frac</span><span class="p">,</span>
                                 <span class="s2">&quot;eps&quot;</span><span class="p">:</span><span class="n">f</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span>
                                 <span class="s2">&quot;sma&quot;</span><span class="p">:</span><span class="n">sma</span><span class="p">,</span>
                                 <span class="s2">&quot;smi&quot;</span><span class="p">:</span><span class="n">sma</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">eps</span><span class="p">),</span>
                                 <span class="s2">&quot;pa&quot;</span><span class="p">:</span><span class="n">f</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span>
                                 <span class="s2">&quot;pa_rad&quot;</span><span class="p">:</span><span class="n">pa_rad</span><span class="p">,</span>
                                 <span class="s2">&quot;cos&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa_rad</span><span class="p">),</span>
                                 <span class="s2">&quot;sin&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa_rad</span><span class="p">),</span>
                                 <span class="s2">&quot;xcen&quot;</span><span class="p">:</span><span class="n">f</span><span class="o">.</span><span class="n">xmed</span><span class="p">,</span>
                                 <span class="s2">&quot;ycen&quot;</span><span class="p">:</span><span class="n">f</span><span class="o">.</span><span class="n">ymed</span><span class="p">})</span>
                    
                <span class="c1"># No iteration, 50% light in one shot.</span>
                <span class="n">dsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
                <span class="c1"># level = pixel value at cumsum = 50%.</span>
                <span class="n">i_reff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">dsort</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mmap_tot</span><span class="p">)</span>                
                <span class="n">frac1</span> <span class="o">=</span> <span class="n">i_reff</span><span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mmap</span><span class="p">)</span>

                <span class="n">d_05reff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dsort</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dsort</span><span class="p">[</span><span class="n">i_reff</span><span class="p">])</span> <span class="c1"># dsort[d_05reff] = 0.5Reff</span>
                <span class="n">frac05</span> <span class="o">=</span> <span class="n">d_05reff</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">mmap</span><span class="p">)</span>

                <span class="n">frac15</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">reff</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> 
                <span class="c1"># fraction of 15kpc in the mmap.</span>
                <span class="n">frac15</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">frac15</span><span class="p">])</span>

                <span class="n">fracs</span> <span class="o">=</span> <span class="p">[</span><span class="n">frac1</span><span class="p">,</span> <span class="n">frac05</span><span class="p">,</span> <span class="n">frac15</span><span class="p">]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1Reff&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5Reff&quot;</span><span class="p">,</span> <span class="s2">&quot;15kpc&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mge_result_list</span><span class="o">=</span><span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">lambda_result_list</span><span class="o">=</span><span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">lambda_r</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">frac</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fracs</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">mge</span><span class="o">.</span><span class="n">find_galaxy</span><span class="o">.</span><span class="n">find_galaxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                <span class="n">mask_shade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                <span class="n">fraction</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>
                    <span class="n">mge_now</span> <span class="o">=</span> <span class="n">get_mge_out</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">npix_per_reff</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mge_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mge_now</span><span class="p">)</span>
                    <span class="n">larr</span> <span class="o">=</span> <span class="n">_measure_lambda</span><span class="p">(</span><span class="n">mge_now</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">lambda_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">larr</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">lambda_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">larr</span><span class="p">[</span><span class="n">npix_per_reff</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">npix_per_reff</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span></div>
                <span class="c1"># End of mge_iterate=False</span>

        <span class="c1">#if save_result:</span>
        <span class="c1">#    self.meta.lambda_arr = result_1reff</span>
        <span class="c1">#    self.meta.lambda_r   = np.average(result_1reff[npix_per_reff])</span>
        <span class="c1">#    self.meta.lambda_arrh= result_hreff</span>
        <span class="c1">#    self.meta.lambda_rh  = np.average(result_hreff[npix_per_reff])</span>
        <span class="c1">#    self.meta.lambda_12kpc = result_15kpc</span>
        <span class="c1">#    self.meta.lambda_r12kpc =np.average(result_15kpc[npix_per_reff])</span>

<span class="c1">#        return self.lambda_result_list, self.lambda_r, self.mge_result_list</span>
        
    
<div class="viewcode-block" id="Galaxy.reorient"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.reorient">[docs]</a>    <span class="k">def</span> <span class="nf">reorient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pop_nvec</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;star&#39;</span><span class="p">],</span>
                 <span class="n">pops</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        rotate particles/cells using rotation matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dest : float array [3]</span>
<span class="sd">            direction vector the normal vector will point to. </span>
<span class="sd">        </span>
<span class="sd">        pop_nvec : a list of galaxy components [&#39;star&#39;, &#39;dm&#39;, &#39;cell&#39;]</span>
<span class="sd">            target_nvec determines with respect to which the galaxy rotates.</span>
<span class="sd">            stellar particels / DM particles/ gas / all particles. </span>
<span class="sd">            Defaults to [&#39;star&#39;].</span>
<span class="sd">        verbose :</span>
<span class="sd">            verbosity.</span>
<span class="sd">                </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Nothing</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            By default, stellar particles by default.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">       </span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nvec&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                fix : nvec w.r.t what?, and what is re-oriented?</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No normal vector, calculating for </span><span class="si">{}</span><span class="s2"> population&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pop_nvec</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_norm_vec</span><span class="p">(</span><span class="n">pop_nvec</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rotation_matrix&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Galaxy.reorientation: No Rotation matrix. </span><span class="se">\n</span><span class="s2"> Calculating..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_rotation_matrix</span><span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nvec</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotation_matrix</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>

        <span class="c1"># New coordinates</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pops</span><span class="p">:</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">RM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_matrix</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">RM</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pop</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])))</span> 
            <span class="n">new_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">RM</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">],</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">],</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">])))</span>

            <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span>

            <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_v</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_v</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_v</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span></div>

<span class="c1">#            print(&quot;Error in reorient, couldn&#39;t update pos and vel&quot;)</span>
<span class="c1">#            continue</span>

<div class="viewcode-block" id="Galaxy.cal_norm_vec"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_norm_vec">[docs]</a>    <span class="k">def</span> <span class="nf">cal_norm_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pop_nvec</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;star&#39;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bound_percentile</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines normal vector (rotation axis) of the galaxy.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pop_nvec : [&quot;name&quot;, &quot;of&quot;, &quot;species&quot;]</span>
<span class="sd">            components for which normal vector is calculated.</span>
<span class="sd">        dest : float array [3]</span>
<span class="sd">            direction vector the normal vector will point to. </span>
<span class="sd">        bound_percentile :</span>
<span class="sd">            Top ?% bound particles are taken into calculation. </span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; self.cal_norm_vec(pop_nvec=[&#39;star&#39;], dest=[0., 0., 1.], bound_percentile=50)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----        </span>
<span class="sd">        &#39;galaxy&#39; means stellar particles by default. </span>
<span class="sd">        Add self.nvec attribute and also returns nvec</span>

<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">            Naab + 2014: normal vector from the most bound 50% particles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
                
        <span class="n">nelements</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pop_nvec</span><span class="p">:</span>
            <span class="n">pop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="c1">#nelements += len(pop[&#39;x&#39;])</span>
            
        <span class="k">if</span> <span class="n">bound_percentile</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
            <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vz</span><span class="p">))</span>
            
            <span class="n">i_bound_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vdiff</span><span class="p">)[:</span><span class="nb">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">bound_percentile</span><span class="p">])</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdiff</span><span class="p">)]</span>
            
            <span class="c1">#pop = getattr(self, target)</span>
            <span class="c1">#nn = len(pop[&#39;x&#39;])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i_bound_50</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">i_bound_50</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">i_bound_50</span><span class="p">]</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="n">vx</span><span class="p">[</span><span class="n">i_bound_50</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="n">vy</span><span class="p">[</span><span class="n">i_bound_50</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="n">vz</span><span class="p">[</span><span class="n">i_bound_50</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                all species are taken into account.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">nelements</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
            <span class="n">iskip</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">pop_nvec</span><span class="p">:</span>
                <span class="n">pop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pop</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                <span class="n">x</span><span class="p">[</span><span class="n">iskip</span><span class="p">:</span><span class="n">iskip</span> <span class="o">+</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
                <span class="n">y</span><span class="p">[</span><span class="n">iskip</span><span class="p">:</span><span class="n">iskip</span> <span class="o">+</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
                <span class="n">z</span><span class="p">[</span><span class="n">iskip</span><span class="p">:</span><span class="n">iskip</span> <span class="o">+</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
                <span class="n">vx</span><span class="p">[</span><span class="n">iskip</span><span class="p">:</span><span class="n">iskip</span> <span class="o">+</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
                <span class="n">vy</span><span class="p">[</span><span class="n">iskip</span><span class="p">:</span><span class="n">iskip</span> <span class="o">+</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
                <span class="n">vz</span><span class="p">[</span><span class="n">iskip</span><span class="p">:</span><span class="n">iskip</span> <span class="o">+</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
                <span class="n">iskip</span> <span class="o">+=</span> <span class="n">nn</span>

        <span class="n">lx</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">vz</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">vy</span><span class="p">)</span> <span class="c1"># normalized; *m is omitted.</span>
        <span class="n">ly</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">vx</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="n">vz</span><span class="p">)</span>
        <span class="n">lz</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">vy</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">vx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lz</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ly</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">lz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#        self.cal_rotation_matrix(dest=dest)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nvec</span></div>

    <span class="k">def</span> <span class="nf">_get_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the rotation matrix associated with counterclockwise rotation about</span>
<span class="sd">        the given axis by theta radians.</span>
<span class="sd">        http://stackoverflow.com/a/6802723 </span>
<span class="sd">        https://en.wikipedia.org/wiki/Euler%E2%80%93Rodrigues_formula</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">axis</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">*</span><span class="n">d</span>
        <span class="n">bc</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">d</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">aa</span><span class="o">+</span><span class="n">bb</span><span class="o">-</span><span class="n">cc</span><span class="o">-</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bc</span><span class="o">+</span><span class="n">ad</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bd</span><span class="o">-</span><span class="n">ac</span><span class="p">)],</span>
                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bc</span><span class="o">-</span><span class="n">ad</span><span class="p">),</span> <span class="n">aa</span><span class="o">+</span><span class="n">cc</span><span class="o">-</span><span class="n">bb</span><span class="o">-</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">cd</span><span class="o">+</span><span class="n">ab</span><span class="p">)],</span>
                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bd</span><span class="o">+</span><span class="n">ac</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">cd</span><span class="o">-</span><span class="n">ab</span><span class="p">),</span> <span class="n">aa</span><span class="o">+</span><span class="n">dd</span><span class="o">-</span><span class="n">bb</span><span class="o">-</span><span class="n">cc</span><span class="p">]])</span>


<div class="viewcode-block" id="Galaxy.cal_rotation_matrix"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_rotation_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">cal_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine Rotation Matrix by axis-angle rotation.</span>
<span class="sd">        </span>
<span class="sd">        parameters</span>
<span class="sd">        -------------</span>
<span class="sd">        nvec : normal vector. </span>
<span class="sd">            If not given, automatically calculated.</span>
<span class="sd">        dest : destination vector ( not axis of rotation!).</span>
<span class="sd">               +z direction ([0, 0, 1]) by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">lag</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="c1"># rotation axis</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="c1"># towards +z direction.</span>
        <span class="k">if</span> <span class="n">nvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">nvec</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">nvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_norm_vec</span><span class="p">()</span> <span class="c1"># Calculate, add, and return .nvec attribute.</span>

        <span class="k">if</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">nvec</span> <span class="o">=</span> <span class="n">nvec</span> <span class="o">/</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">/</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="n">r_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

        <span class="n">RM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rotation_matrix</span><span class="p">(</span><span class="n">r_axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">RM</span>
        <span class="k">return</span> <span class="n">RM</span></div>

    <span class="k">def</span> <span class="nf">_follow_bp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Follow bound particle..</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
<div class="viewcode-block" id="Galaxy.cal_bound_ptcls"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_bound_ptcls">[docs]</a>    <span class="k">def</span> <span class="nf">cal_bound_ptcls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="n">bound50</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">gas_mass</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                return gas mass of cells. </span>
<span class="sd">                Keep in mind that the size of cells differ. </span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">msun</span> <span class="o">=</span> <span class="mf">1.98892e33</span> <span class="c1"># solar mass in gram.</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">unit_d</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">unit_l</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">msun</span>
        <span class="c1"># what is bound particle? </span>
        
        <span class="n">G</span> <span class="o">=</span> <span class="mf">6.67384e-11</span>  <span class="c1"># m^3 kg^-1 s^-2</span>
        <span class="n">kpc_to_m</span> <span class="o">=</span> <span class="mf">3.08567758e19</span> 
        <span class="n">msun_to_kg</span> <span class="o">=</span> <span class="mf">1.9891e30</span> <span class="c1"># kg</span>
        
        <span class="n">m_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="c1"># * info.msun</span>
        <span class="n">m_g</span> <span class="o">=</span> <span class="n">gas_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">m_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="c1"># * info.msun</span>
    
        <span class="n">r_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
        <span class="n">r_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
        <span class="n">r_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
       
        <span class="n">m_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">m_s</span><span class="p">,</span> <span class="n">m_g</span><span class="p">,</span> <span class="n">m_d</span><span class="p">))</span>
        <span class="n">r_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_s</span><span class="p">,</span> <span class="n">r_g</span><span class="p">,</span> <span class="n">r_d</span><span class="p">))</span>
        
        <span class="n">i_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">r_all</span><span class="p">)</span> <span class="c1"># r_all[i_sorted] = 0, 0.1, 0.2, 0.3, ... 100</span>
        <span class="n">m_enc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m_all</span><span class="p">[</span><span class="n">i_sorted</span><span class="p">])</span>
    
        <span class="n">i_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">r_all</span><span class="p">[</span><span class="n">i_sorted</span><span class="p">],</span> <span class="n">r_s</span><span class="p">)</span>
               
        <span class="n">v_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">G</span><span class="o">*</span><span class="n">m_enc</span><span class="p">[</span><span class="n">i_star</span><span class="p">]</span> <span class="o">*</span> <span class="n">msun_to_kg</span><span class="o">/</span> <span class="p">(</span><span class="n">r_s</span> <span class="o">*</span> <span class="n">kpc_to_m</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span>
        
        <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
    
        <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vz</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span> <span class="o">=</span> <span class="n">vdiff</span> <span class="o">&lt;</span> <span class="n">v_bound</span>        </div>


<div class="viewcode-block" id="Galaxy.bound_particles"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.bound_particles">[docs]</a>    <span class="k">def</span> <span class="nf">bound_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save IDs of n most bound particles as galaxy.most_bound_particles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int</span>
<span class="sd">            number of most bound particles to be kept. </span>
<span class="sd">        ptype : str &quot;star&quot; or &quot;dm&quot;</span>
<span class="sd">            Type of particle.</span>
<span class="sd">            </span>
<span class="sd">        NOTE</span>
<span class="sd">        ----</span>
<span class="sd">        The result has no use yet... I don&#39;t know why I have this...</span>
<span class="sd">        Requires center of mass and center of velocity already determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#vrange = 100</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
    
        <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vxc</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vyc</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">vz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vzc</span><span class="p">)</span>
        <span class="n">npart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdiff</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">npart</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Too little particles within velocity window km/s&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
        <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vdiff</span><span class="p">)[:</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">npart</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">most_bound_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">emin</span><span class="p">]</span></div>
        
    
<div class="viewcode-block" id="Galaxy.cal_b2t"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_b2t">[docs]</a>    <span class="k">def</span> <span class="nf">cal_b2t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="n">disk_criterion</span><span class="o">=</span><span class="s2">&quot;Abadi2003&quot;</span><span class="p">,</span>
                <span class="n">bound_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure bulge to total ratio of the galaxy.</span>
<span class="sd">        </span>
<span class="sd">        parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ptype : str</span>
<span class="sd">            type of particle to consider.</span>
<span class="sd">        disk_criterion : str </span>
<span class="sd">            discrimination criterion. (Defaults to &quot;Abadi2003&quot;)</span>
<span class="sd">        bound_only : logical</span>
<span class="sd">            consider bound particles only</span>
<span class="sd">        hist : logical</span>
<span class="sd">            if True, ellipticity histogram is returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">gas_mass</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                return mass of gas cells. </span>
<span class="sd">                Keep in mind that size of cells differ. </span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">msun</span> <span class="o">=</span> <span class="mf">1.98892e33</span> <span class="c1"># solar mass in gram.</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">unit_d</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">info</span><span class="o">.</span><span class="n">unit_l</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">/</span> <span class="n">msun</span>
            
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">if</span> <span class="n">proj</span><span class="o">==</span><span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">vel1</span><span class="p">,</span> <span class="n">vel2</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="s1">&#39;vz&#39;</span>
        <span class="k">if</span> <span class="n">proj</span><span class="o">==</span><span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">vel1</span><span class="p">,</span> <span class="n">vel2</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;vz&#39;</span><span class="p">,</span> <span class="s1">&#39;vx&#39;</span>
        <span class="k">if</span> <span class="n">proj</span><span class="o">==</span><span class="s2">&quot;z&quot;</span><span class="p">:</span>
            <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">vel1</span><span class="p">,</span> <span class="n">vel2</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="s1">&#39;vy&#39;</span>



        <span class="c1"># Radius</span>

        <span class="c1"># Calculating boundness requires total mass inside a radius.</span>
        <span class="c1"># -&gt; DM, Cell are also needed. </span>
        <span class="c1">#part = getattr(self, ptype)</span>

        <span class="n">m_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="c1"># * info.msun</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cell&quot;</span><span class="p">):</span>
            <span class="n">m_g</span> <span class="o">=</span> <span class="n">gas_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="n">m_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">m_g</span><span class="p">,</span> <span class="n">m_d</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">m_d</span><span class="p">))</span>
        

        <span class="n">r_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cell&quot;</span><span class="p">):</span>
            <span class="n">r_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
        <span class="n">r_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cell&quot;</span><span class="p">):</span>
            <span class="n">r_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_s</span><span class="p">,</span> <span class="n">r_g</span><span class="p">,</span> <span class="n">r_d</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_s</span><span class="p">,</span> <span class="n">r_d</span><span class="p">))</span>
        <span class="n">i_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">r_all</span><span class="p">)</span>
        <span class="n">m_enc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m_all</span><span class="p">[</span><span class="n">i_sorted</span><span class="p">])</span>
       
        <span class="c1"># First nstar indices are stars.</span>
        <span class="k">if</span> <span class="n">bound_only</span><span class="p">:</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="n">i_sorted</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">pos1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">pos2</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">vel1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">vel2</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_ptcl</span><span class="p">]</span><span class="c1"># * info.msun</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i_star</span> <span class="o">=</span> <span class="n">i_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">r_s</span><span class="p">)]</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">pos1</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">pos2</span><span class="p">]</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">vel1</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">vel2</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="c1"># * info.msun</span>

        <span class="c1">#boxtokpc = self.info.pboxsize * 1000</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">6.67384e-11</span>  <span class="c1"># m^3 kg^-1 s^-2</span>
        <span class="n">kpc_to_m</span> <span class="o">=</span> <span class="mf">3.08567758e19</span> 
        <span class="n">msun_in_kg</span> <span class="o">=</span> <span class="mf">1.9891e30</span> <span class="c1"># kg</span>
        <span class="n">v_circ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G</span> <span class="o">*</span> <span class="n">msun_in_kg</span> <span class="o">*</span> <span class="n">m_enc</span><span class="p">[</span><span class="n">i_star</span><span class="p">]</span><span class="o">/</span>
                        <span class="p">(</span><span class="n">kpc_to_m</span> <span class="o">*</span> <span class="n">r_all</span><span class="p">[</span><span class="n">i_star</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># m/s to in km/s</span>

        <span class="n">j_circ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> 
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_circ</span> <span class="c1"># * boxtokpc omitted (later compensated.)</span>
        <span class="c1"># Finally, r in code unit, v in km/s</span>
        <span class="n">j_phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">vy</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">vx</span><span class="p">)</span> <span class="c1"># * boxtokpc omitted.</span>
        <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">j_phi</span> <span class="o">/</span> <span class="n">j_circ</span>
        
        <span class="k">if</span> <span class="n">disk_criterion</span> <span class="o">==</span> <span class="s2">&quot;Scannapieco2009&quot;</span><span class="p">:</span>
            <span class="c1"># &lt; 0.8 from Scannapieco 2009</span>
            <span class="n">disk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">ellipticity</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">disk_criterion</span> <span class="o">==</span> <span class="s2">&quot;Abadi2003&quot;</span><span class="p">:</span>
            <span class="c1">#bulge = 2.0 * np.sum(self.star[&#39;m&#39;][j_phi &lt; 0])</span>
            <span class="n">bulge</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="nb">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">j_phi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">j_phi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])])</span>
            <span class="n">disk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">bulge</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">d2t</span> <span class="o">=</span> <span class="n">disk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span> <span class="c1"># or sum(self.star[&#39;m&#39;][ind])</span>
        <span class="k">if</span> <span class="n">hist</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span></div>



<div class="viewcode-block" id="Galaxy.cal_trivia"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.cal_trivia">[docs]</a>    <span class="k">def</span> <span class="nf">cal_trivia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">vcen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vcen</span><span class="p">()</span></div>

<div class="viewcode-block" id="Galaxy.save_gal_pickle"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.save_gal_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">save_gal_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;gal.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>
            
            
<div class="viewcode-block" id="Galaxy.stellar_map"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.stellar_map">[docs]</a>    <span class="k">def</span> <span class="nf">stellar_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">            returns stellar density map.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        
        
         
<div class="viewcode-block" id="Galaxy.plot_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.plot_gal">[docs]</a>    <span class="k">def</span> <span class="nf">plot_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">fn_save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ioff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">do9plots</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">i_lambda</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">representative</span><span class="o">=</span><span class="s2">&quot;1Reff&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            i_lambda: int</span>
<span class="sd">                index of gal.meta.lambda_result_list to be plotted as lambda profile.</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
                
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">ticker</span>
        <span class="kn">from</span> <span class="nn">draw</span> <span class="k">import</span> <span class="n">pp</span>
        <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LogNorm</span>
<span class="c1">#        import utils.prettyplot as ptt</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">ioff</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">r&#39;$</span><span class="si">{}</span><span class="s1"> \times 10^{{</span><span class="si">{}</span><span class="s1">}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">_close_to</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">v_ref</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                returns the index of the value which is close to the v_ref.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">good</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vv</span> <span class="o">-</span> <span class="n">v_ref</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">good</span><span class="p">:</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="n">vv</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
            
            <span class="k">return</span> <span class="n">ind</span>

        <span class="n">rgal_to_reff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">Rgal_to_reff</span>

        <span class="k">if</span> <span class="n">do9plots</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># 9 plots</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;ID: </span><span class="si">{}</span><span class="s2">    z: </span><span class="si">{:2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">zred</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;ID: </span><span class="si">{}</span><span class="s2">    z: not available&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>

<span class="c1"># Stellar particle density map</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            1st plot. - Stellar density map. </span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if hist=True, use histogram instead of custom CIC.</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">part2den</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="n">npix</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">),</span>
                       <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="n">e6</span><span class="p">))</span>
<span class="c1">#        _,_,_,im = ax.hist2d( self.star[&#39;x&#39;], self.star[&#39;y&#39;], norm=LogNorm(), bins=npix)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
<span class="c1">#   Todo:</span>
<span class="c1">#   If rgal_to_reff is not too large, say 10. xticks are too dense. </span>
<span class="c1">#   If 8, or 9 is given, use 4, if 10, use 5, and so on.. </span>
<span class="c1">#   Utilize _close_to function.         </span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">rgal_to_reff</span><span class="p">))</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">rgal_to_reff</span><span class="p">,</span> <span class="n">rgal_to_reff</span><span class="p">,</span> <span class="n">rgal_to_reff</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xticks</span><span class="p">])</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[kpc]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> \
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rgal</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>

<span class="c1"># Lambda_r plot</span>
        <span class="n">ll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">lambda_result_list</span><span class="p">[</span><span class="n">i_lambda</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ll</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="c1"># ~ 1 * Reff</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;$\lambda _</span><span class="si">{R}</span><span class="s2">$&quot;</span><span class="p">)</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">mstar</span><span class="p">)</span> <span class="o">+</span> <span class="s2">r&quot;$M_{\odot}$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            
            <span class="n">unit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span> <span class="c1"># number of points per 1Reff</span>
            <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">unit</span><span class="p">]</span>
            <span class="n">reffs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">)):</span> <span class="c1"># If lambda_r is calculated furthrer -</span>
                <span class="n">xticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">reffs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
            <span class="n">xticks_label</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span> <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">reffs</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks_label</span><span class="p">)</span>

<span class="c1"># sigma map</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;sigmap&quot;</span><span class="p">):</span>
            <span class="n">l_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>        
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$km s^{-1}$&#39;</span><span class="p">)</span> <span class="c1"># needs a mappable object.</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;$\sigma$ map&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">),</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[kpc]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">l_range</span><span class="p">,</span> <span class="n">l_range</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>        
<span class="c1">#        ax.locator_params(tight=True, nbins=5)</span>

<span class="c1"># velocity map</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>
    <span class="c1">#        ax.tick_params(</span>
    <span class="c1">#            which=&#39;both&#39;,      # both major and minor ticks are affected</span>
    <span class="c1">#            bottom=&#39;off&#39;,      # ticks along the bottom edge are off</span>
    <span class="c1">#            top=&#39;off&#39;,         # ticks along the top edge are off</span>
    <span class="c1">#            labelbottom=&#39;off&#39;)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$km s^{-1}$&#39;</span><span class="p">)</span> <span class="c1"># needs a mappable object.</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;RdYlBu&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;velocity map&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">),</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[kpc]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">reff</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>        
              
<span class="c1">#        ax.locator_params(tight=True, nbins=5)</span>

        <span class="k">if</span> <span class="n">do9plots</span><span class="p">:</span>
    <span class="c1"># position and velocity histograms</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>        
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;X pos&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Y pos&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;X vel&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Y vel&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>        
        <span class="k">if</span> <span class="n">fn_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_save</span> <span class="o">=</span> <span class="s2">&quot;galaxy_plot&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn_save</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
       
<div class="viewcode-block" id="Galaxy.save_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy.Galaxy.save_gal">[docs]</a>    <span class="k">def</span> <span class="nf">save_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">clazz</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Out of all attributes of a galaxy instance, leave only data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">clazz</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> 
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">staticmethod</span><span class="p">}</span>
        
        <span class="k">def</span> <span class="nf">get_metadata2</span><span class="p">(</span><span class="n">adict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">adict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))}</span>


        <span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">hdf</span>
        <span class="c1"># Save data into a hdf5 file</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">hdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_gal.hdf5&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>
        
        <span class="c1"># Store metadata in HDF5 attributes</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">get_metadata2</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">atr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">atr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">atr</span><span class="p">)</span>
            <span class="c1">#outfile.attrs[name] = atr</span>
        
        <span class="c1"># Store data under /selfaxy with direct assignment</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;star&#39;</span><span class="p">):</span>
            <span class="c1">#print(&quot;Saving star&quot;)</span>
            <span class="n">star</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;star&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">star</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dm&#39;</span><span class="p">):</span>
            <span class="c1">#print(&quot;Saving DM&quot;)</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;dm&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">dm</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">):</span>
            <span class="c1">#print(&quot;Saving gas&quot;)</span>
            <span class="n">gas</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;gas&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">gas</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        
        <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyclusterevol -0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Hoseung.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>