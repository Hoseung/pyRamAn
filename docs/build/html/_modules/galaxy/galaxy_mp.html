<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>galaxy.galaxy_mp &#8212; pyclusterevol -0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '-0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="pyclusterevol -0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyclusterevol -0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for galaxy.galaxy_mp</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Apr 24 23:45:55 2015</span>

<span class="sd">Measure ICL fraction by merger channel</span>


<span class="sd">@author: hoseung</span>

<span class="sd">Inherites halo.HaloMeta. HaloMeta does not contain </span>
<span class="sd">positional and kinematic information of the halo. This is good because</span>
<span class="sd">recalculated center of galaxy is likely to deviate from the center of the halo. </span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Galaxy"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy">[docs]</a><span class="k">class</span> <span class="nc">Galaxy</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">halo</span><span class="p">,</span> <span class="n">radius_method</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1">#        self.set_sim(sim)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_halo</span><span class="p">(</span><span class="n">halo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halo</span> <span class="o">=</span> <span class="n">halo</span>
<span class="c1">#    def set_sim(self, sim):</span>
<span class="c1">#        self.sim = sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstar</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pq</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfr</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssfr</span><span class="o">=</span><span class="mf">0.0</span>

<div class="viewcode-block" id="Galaxy.set_halo"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.set_halo">[docs]</a>    <span class="k">def</span> <span class="nf">set_halo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">halo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halo</span> <span class="o">=</span> <span class="n">halo</span></div>
        
<div class="viewcode-block" id="Galaxy.set_ptypes"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.set_ptypes">[docs]</a>    <span class="k">def</span> <span class="nf">set_ptypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>
   
<div class="viewcode-block" id="Galaxy.physical_print"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.physical_print">[docs]</a>    <span class="k">def</span> <span class="nf">physical_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># If length, </span>
        
        <span class="nb">print</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span></div>
    
<div class="viewcode-block" id="Galaxy.mk_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.mk_gal">[docs]</a>    <span class="k">def</span> <span class="nf">mk_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rscale</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making a galaxy:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">rscale_cen</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="n">xc_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">yc_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">zc_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">rr_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;rvir&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rscale_cen</span><span class="p">,</span> <span class="mf">0.0002</span><span class="p">])</span> <span class="c1"># arbitrary! &lt; 20kpc</span>
        <span class="n">rr_tmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">rr_tmp</span><span class="p">,</span> <span class="mf">0.000025</span><span class="p">])</span>
        <span class="c1"># When merger occurs, larger radius is likely to include </span>
        <span class="c1"># companion galaxy resulting center to be in the middle of nowhere.</span>
        <span class="c1"># If you want larger galaxy, </span>
        <span class="c1"># increase rgal_tmp instead. </span>
        <span class="c1"># xx is easier to search for than x.</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Searching particles insdie the radius..&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rr_tmp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;kpc&#39;</span><span class="p">])</span>
        
        <span class="n">xall</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> 
        <span class="n">zall</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> 

        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xall</span> <span class="o">-</span> <span class="n">xc_tmp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yall</span> <span class="o">-</span> <span class="n">yc_tmp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
                            <span class="o">+</span> <span class="p">(</span><span class="n">zall</span> <span class="o">-</span> <span class="n">zc_tmp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">rr_tmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;there are </span><span class="si">{}</span><span class="s2"> particles inside the radius1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)))</span>
        
        <span class="n">xc_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xall</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">yc_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">yall</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">zc_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">zall</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now guessed center is :&quot;</span><span class="p">,</span> <span class="n">xc_tmp</span><span class="p">,</span> <span class="n">yc_tmp</span><span class="p">,</span> <span class="n">zc_tmp</span><span class="p">)</span>

        <span class="n">rr_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;rvir&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rscale</span><span class="p">,</span> <span class="mf">0.00025</span><span class="p">])</span> <span class="c1"># modified!</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Search for particles around the guessed center, within...&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;radius2&quot;</span><span class="p">,</span> <span class="n">rr_tmp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;kpc&#39;</span><span class="p">])</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xall</span> <span class="o">-</span> <span class="n">xc_tmp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yall</span> <span class="o">-</span> <span class="n">yc_tmp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> 
                            <span class="o">+</span> <span class="p">(</span><span class="n">zall</span> <span class="o">-</span> <span class="n">zc_tmp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">rr_tmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of particles:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="n">xall</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">yall</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> 
        <span class="n">zz</span> <span class="o">=</span> <span class="n">zall</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> 
        <span class="n">mm</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> 

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># First, define the center w.r.t. stars.</span>
        <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">zc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_center</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">mm</span><span class="p">)</span> <span class="c1"># STARS!</span>

<span class="c1">#        self.physical_print([xc_tmp, yc_tmp, zc_tmp])</span>

<span class="c1">#        self.physical_print([xc, yc, zc])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">xc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yc</span> <span class="o">=</span> <span class="n">yc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zc</span> <span class="o">=</span> <span class="n">zc</span>

<span class="c1"># Second, define the search radius</span>
<span class="c1"># Only &#39;simple&#39; works, because &#39;star&#39; is not defined yet.</span>
        <span class="n">rgal_tmp</span> <span class="o">=</span> <span class="n">rr_tmp</span>
        
        <span class="k">if</span> <span class="n">dm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                            <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                            <span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">rgal_tmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ndm_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idm</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">(</span><span class="n">ndm_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> 
            <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">zc</span>
            <span class="k">if</span> <span class="s1">&#39;vy&#39;</span> <span class="ow">in</span> <span class="n">dm</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span><span class="c1"># - self.vxc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span><span class="c1"># - self.vyc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">idm</span><span class="p">]</span><span class="c1"># - self.vzc</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DM data stored&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">star</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">istar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                            <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                            <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">rgal_tmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nstar_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">istar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nstar tot:&quot;</span><span class="p">,</span> <span class="n">nstar_tot</span><span class="p">)</span>        
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Store stellar particle&quot;</span><span class="p">)</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">(</span><span class="n">nstar_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
            <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yc</span>
            <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">zc</span>
            <span class="k">if</span> <span class="s1">&#39;vx&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;vy&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;vz&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">utils.cosmology</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">time2gyr</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">],</span>
                                             <span class="n">z_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">zred</span><span class="p">,</span>
                                             <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;metal&#39;</span> <span class="ow">in</span> <span class="n">star</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;metal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;metal&#39;</span><span class="p">][</span><span class="n">istar</span><span class="p">]</span>           

        <span class="c1"># Or, hasattr(self, &#39;sink&#39;)</span>
<span class="c1">#        if &#39;sink&#39; in part.pt:        </span>
<span class="c1">#            dtype = part._get_dtype(&quot;sink&quot;)</span>
<span class="c1">#            self.sink = np.recarray(nsink_tot * 2109, dtype=dtype)</span>
<span class="c1">#            isink = np.where( (part.star[&quot;x&quot;] - xc)**2 + </span>
<span class="c1">#                            (part.star[&quot;y&quot;] - yc)**2 + </span>
<span class="c1">#                            (part.star[&quot;z&quot;] - zc)**2 &lt;= rgal_tmp**2)[0]        </span>
<span class="c1">#            nsink_tot = len(isink)</span>
        <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">icell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                <span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">rgal_tmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ncell_tot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">icell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">(</span><span class="n">ncell_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">zc</span>           
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var0&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var2&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var3&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var4&#39;</span><span class="p">][</span><span class="n">icell</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_mgas</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculate Effective radius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_radius</span><span class="p">(</span><span class="s2">&quot;eff&quot;</span><span class="p">)</span>
        <span class="n">rgal_tmp</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">reff</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        print(&quot;Rgal = 4 * Reff = &quot;, rgal_tmp * self.info.pboxsize * 1000)</span>
<span class="sd">        </span>
<span class="sd">            # Save sink particle as a BH, not cloud particles. </span>

<span class="sd">        print(&#39;Simple check:&#39;)</span>
<span class="sd">        print(&quot;mean particle positions:&quot;, </span>
<span class="sd">              np.mean(self.star[&#39;x&#39;]),</span>
<span class="sd">            np.mean(self.star[&#39;y&#39;]),</span>
<span class="sd">            np.mean(self.star[&#39;z&#39;]))</span>


<span class="sd">        print(&quot;median particle positions:&quot;, </span>
<span class="sd">              np.median(self.star[&#39;x&#39;]),</span>
<span class="sd">            np.median(self.star[&#39;y&#39;]),</span>
<span class="sd">            np.median(self.star[&#39;z&#39;]))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstar</span> <span class="o">=</span> <span class="n">nstar_tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
        <span class="c1"># Now, get cov</span>
        <span class="kn">import</span> <span class="nn">utils.sampling</span> <span class="k">as</span> <span class="nn">smp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">set_region</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="n">yc</span><span class="p">,</span> <span class="n">zc</span><span class="o">=</span><span class="n">zc</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="n">rgal_tmp</span><span class="p">)</span>
        
<span class="c1">#        print(&quot;before get_cov&quot;, time.time() - t0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_cov</span><span class="p">(</span><span class="n">center_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#        print(&quot;after get_cov&quot;, time.time() - t0)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Galaxy.get_radius"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.get_radius">[docs]</a>    <span class="k">def</span> <span class="nf">get_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;rvir&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;eff&quot;</span><span class="p">:</span>
            <span class="c1"># requires galaxy center to be determined. </span>
            <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
<span class="c1">#            npart = len(dd)</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
            <span class="n">r_again</span> <span class="o">=</span> <span class="n">dmax</span>
            <span class="n">m_annuli</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">nbin</span><span class="o">=</span><span class="mi">8</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
                <span class="n">m_annuli</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dmax</span><span class="o">/</span><span class="n">nbin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dmax</span><span class="o">/</span><span class="n">nbin</span><span class="p">)]))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m_annuli</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m_annuli</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">r_again</span> <span class="o">=</span> <span class="n">dmax</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nbin</span>
                    <span class="k">break</span>
            <span class="n">i_again</span> <span class="o">=</span> <span class="n">dd</span> <span class="o">&lt;</span> <span class="n">r_again</span>
            <span class="n">dsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">i_again</span><span class="p">])</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">i_again</span><span class="p">]</span>
            <span class="c1"># half-mass radius, not half-particle radius.</span>
            <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">dsort</span><span class="p">])</span>

            <span class="n">ihalf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumsum</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># If two galaxies are merging, </span>
            <span class="c1"># Chances are cumsum has a flat interval. </span>
            <span class="c1"># If there is such anormaly, measure Reff again by</span>
            <span class="c1"># shirinking the radius a bit.</span>
            <span class="n">reff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">i_again</span><span class="p">][</span><span class="n">dsort</span><span class="p">[</span><span class="n">ihalf</span><span class="p">]])</span>
            <span class="c1"># Rough profile</span>

            <span class="k">return</span> <span class="n">reff</span></div>

<div class="viewcode-block" id="Galaxy.get_center"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.get_center">[docs]</a>    <span class="k">def</span> <span class="nf">get_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the center of mass of given particles.</span>
<span class="sd">        IDL version was to iteratively search for mass weighted mean position of</span>
<span class="sd">        particles within gradually decreasing search radius. </span>
<span class="sd">        Let&#39;s do the same thing here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">/</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># 10kpc/h</span>
        <span class="c1"># Stops if r &lt; 10pc</span>
        <span class="c1"># or, if dx_3d &lt; 5 pc</span>
        <span class="n">msum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">xc_old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
        <span class="n">yc_old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
        <span class="n">zc_old</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
    
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>    
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niter</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="p">:</span>
            
            <span class="n">msum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
            <span class="n">yc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
            <span class="n">zc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">msum</span>
            
            <span class="n">dx3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xc_old</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yc_old</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">zc_old</span> <span class="o">-</span> <span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dx3</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span>
                <span class="k">break</span>
    
            <span class="c1"># shrink the search radius by half.</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">zc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    
            <span class="n">r</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ptp</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">ptp</span><span class="p">()])</span>
    
            <span class="n">xc_old</span> <span class="o">=</span> <span class="n">xc</span>
            <span class="n">yc_old</span> <span class="o">=</span> <span class="n">yc</span>
            <span class="n">zc_old</span> <span class="o">=</span> <span class="n">zc</span>
            
            <span class="n">i</span> <span class="o">+=</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">zc</span></div>

<div class="viewcode-block" id="Galaxy.get_cov2"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.get_cov2">[docs]</a>    <span class="k">def</span> <span class="nf">get_cov2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vxc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vyc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vxc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vyc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vzc</span></div>


<div class="viewcode-block" id="Galaxy.e_vdiff"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.e_vdiff">[docs]</a>    <span class="k">def</span> <span class="nf">e_vdiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">vxt</span><span class="p">,</span> <span class="n">vyt</span><span class="p">,</span> <span class="n">vzt</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">vxt</span> <span class="o">-</span> <span class="n">vxt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">vyt</span> <span class="o">-</span> <span class="n">vyt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">vzt</span> <span class="o">-</span> <span class="n">vzt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">vdiff</span><span class="p">[</span><span class="n">vdiff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span></div>
    

<div class="viewcode-block" id="Galaxy.get_cov"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.get_cov">[docs]</a>    <span class="k">def</span> <span class="nf">get_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multithreaded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">if</span> <span class="n">center_only</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
                          <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
                          <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reff</span> <span class="p">)</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
            <span class="n">vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>

        <span class="n">vhalx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
        <span class="n">vhaly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
        <span class="n">vhalz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
        
        <span class="n">r_frac</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">vrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vx</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vy</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vz</span><span class="p">)])</span> <span class="o">*</span> <span class="mi">3</span>
        
        <span class="n">vind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vx</span> <span class="o">-</span> <span class="n">vhalx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                        <span class="p">(</span><span class="n">vy</span> <span class="o">-</span> <span class="n">vhaly</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">vz</span> <span class="o">-</span> <span class="n">vhalz</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">r_frac</span> <span class="o">*</span> <span class="n">vrange</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">npart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vind</span><span class="p">)</span>        
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;com&quot;</span>
        
        <span class="c1"># Add adaptivity</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mostbound&quot;</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">npart</span> <span class="o">&gt;</span> <span class="mi">80000</span><span class="p">:</span>
                <span class="n">r_frac</span> <span class="o">*=</span> <span class="mf">0.7</span>
                <span class="n">vind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">vx</span> <span class="o">-</span> <span class="n">vxt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                    <span class="p">(</span><span class="n">vy</span> <span class="o">-</span> <span class="n">vyt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="p">(</span><span class="n">vz</span> <span class="o">-</span> <span class="n">vzt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">r_frac</span> <span class="o">*</span> <span class="n">vrange</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">npart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vind</span><span class="p">)</span>
            <span class="n">vind</span> <span class="o">=</span> <span class="n">vind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">npart</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
<span class="c1"># sparsely selected representative particles.</span>
            <span class="n">vxt</span> <span class="o">=</span> <span class="n">vx</span><span class="p">[</span><span class="n">vind</span><span class="p">]</span>
            <span class="n">vyt</span> <span class="o">=</span> <span class="n">vy</span><span class="p">[</span><span class="n">vind</span><span class="p">]</span>
            <span class="n">vzt</span> <span class="o">=</span> <span class="n">vz</span><span class="p">[</span><span class="n">vind</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
            <span class="c1"># this takes ~ 30s. with roughly the same number of particles. </span>
            <span class="n">multithreaded</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">multithreaded</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span>
                <span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">repeat</span>
                <span class="sd">&quot;&quot;&quot; Why no performance improvement at all..???&quot;&quot;&quot;</span>
        
                <span class="n">pool</span><span class="o">=</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e_vdiff</span><span class="p">,</span>
                                 <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vxt</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                                    <span class="n">repeat</span><span class="p">(</span><span class="n">vxt</span><span class="p">),</span>
                                    <span class="n">repeat</span><span class="p">(</span><span class="n">vyt</span><span class="p">),</span>
                                    <span class="n">repeat</span><span class="p">(</span><span class="n">vzt</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">multithreaded</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vxt</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">vdiff</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">vxt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">vxt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                                  <span class="p">(</span><span class="n">vyt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">vyt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                  <span class="p">(</span><span class="n">vzt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">vzt</span><span class="p">[</span><span class="n">iv</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">e</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">vdiff</span><span class="p">[</span><span class="n">vdiff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    
<span class="c1"># N parts that are most bound to &lt;50000 &#39;central&#39; particle group.</span>
            <span class="n">emin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">5000</span><span class="p">]</span>
            
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">vind</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vxc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vxt</span><span class="p">[</span><span class="n">emin</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="n">emin</span><span class="p">])</span> <span class="c1"># top 100 </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vyc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vyt</span><span class="p">[</span><span class="n">emin</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="n">emin</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vzt</span><span class="p">[</span><span class="n">emin</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="n">emin</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;com&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vxc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vyc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vzc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_center</span><span class="p">(</span>
                                <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vxc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vyc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vzc</span></div>
    
<div class="viewcode-block" id="Galaxy.cal_mgas"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_mgas">[docs]</a>    <span class="k">def</span> <span class="nf">cal_mgas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mgas</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="Galaxy.cal_sfr"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_sfr">[docs]</a>    <span class="k">def</span> <span class="nf">cal_sfr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utils</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="c1"># average over last 100Myrs</span>
        <span class="n">time_new</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># in Myr</span>
        <span class="n">ind_new_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">cosmology</span><span class="o">.</span><span class="n">time2myr</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">z_now</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">zred</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">time_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m_star_new</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind_new_star</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfr</span><span class="o">=</span><span class="n">m_star_new</span> <span class="o">/</span> <span class="n">time_new</span>
        <span class="k">return</span> <span class="n">m_star_new</span> <span class="o">/</span> <span class="n">time_new</span></div>
    
<div class="viewcode-block" id="Galaxy.cal_ssfr"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_ssfr">[docs]</a>    <span class="k">def</span> <span class="nf">cal_ssfr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_sfr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfr</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mstar</span></div>

<div class="viewcode-block" id="Galaxy.cal_vrot"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_vrot">[docs]</a>    <span class="k">def</span> <span class="nf">cal_vrot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>    
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Galaxy.dist_map"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.dist_map">[docs]</a>    <span class="k">def</span> <span class="nf">dist_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">npix</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">npix</span>
        
        <span class="n">dist_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="n">dist_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">j</span> <span class="o">-</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist_map</span></div>

<div class="viewcode-block" id="Galaxy.weighted_std"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.weighted_std">[docs]</a>    <span class="k">def</span> <span class="nf">weighted_std</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the weighted average and standard deviation.</span>
<span class="sd">    </span>
<span class="sd">        values, weights -- Numpy ndarrays with the same shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">values</span><span class="o">-</span><span class="n">average</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># Fast and numerically precise</span>
           
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span></div>
    
        
<div class="viewcode-block" id="Galaxy.cal_lambda_r"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_lambda_r">[docs]</a>    <span class="k">def</span> <span class="nf">cal_lambda_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">rscale</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="c1"># Only within effective radius. (or whatever radius.)</span>
        <span class="c1"># already centered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rscale_lambda</span> <span class="o">=</span> <span class="n">rscale</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reff</span> <span class="o">*</span> <span class="n">rscale</span>
        <span class="n">npix2</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">npix</span> <span class="o">*</span> <span class="n">rscale</span><span class="p">)</span>

        <span class="n">ind_ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">rr</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">rr</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Some margin make mmap and vmap look better.</span>
<span class="c1"># But only inside Lambda_R for R &lt; Reff is returned. </span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> particles inside </span><span class="si">{}</span><span class="s2">kpc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_ok</span><span class="p">),</span> 
                    <span class="n">rr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">ind_ok</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">ind_ok</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">ind_ok</span><span class="p">]</span>
        <span class="n">vz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">][</span><span class="n">ind_ok</span><span class="p">]</span>
        
        <span class="c1"># NGP charge assignment         </span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">npix2</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">npix2</span>

        <span class="c1"># distance in pixel unit.</span>
        <span class="n">dist2d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="n">dist2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">j</span> <span class="o">-</span> <span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                
        <span class="n">dist1d</span> <span class="o">=</span> <span class="n">dist2d</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># fix center explicitely.</span>
        <span class="c1"># 0.5 * (min + max) != center</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">rr</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nx</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">rr</span><span class="p">)</span> <span class="o">/</span> <span class="n">rr</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ny</span>
        
        <span class="n">ngx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ngy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">yy</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">indices</span> <span class="o">=</span> <span class="n">ngx</span> <span class="o">+</span> <span class="n">ngy</span> <span class="o">*</span> <span class="n">nx</span>

        <span class="n">mmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">npix2</span>
        <span class="n">mmap</span> <span class="o">=</span> <span class="n">mmap</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        
        <span class="n">vmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1"># mass-weighted sigma         </span>
        <span class="n">sigmap</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sigmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_std</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="n">vmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sigmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dist1d</span> <span class="o">=</span> <span class="n">dist1d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="o">=</span> <span class="n">vmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">npix</span><span class="p">)</span> <span class="c1"># 1.5 Reff</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>            
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dist1d</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist1d</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">dist1d</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sigmap</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mmap</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">dist1d</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span> 
                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vmap</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigmap</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">ind2</span><span class="p">]]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">*</span><span class="n">rr</span><span class="o">/</span><span class="n">npoints</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dd</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rr</span><span class="o">/</span><span class="n">npoints</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">dd</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">vv</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_std</span><span class="p">(</span><span class="n">vz</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">dd</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span> <span class="o">=</span> <span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_r</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lambda_arr done&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Galaxy.reorient"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.reorient">[docs]</a>    <span class="k">def</span> <span class="nf">reorient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">modify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        part can be of any type.</span>
<span class="sd">        It&#39;s stellar particles by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#        import numpy as np</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nvec&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_norm_vec</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">RM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_matrix</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Galaxy.reorientation: No Rotation matrix. </span><span class="se">\n</span><span class="s2"> Calculating..&quot;</span><span class="p">)</span>
            <span class="n">RM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_rotation_matrix</span><span class="p">()</span>       
        
        <span class="c1"># New coordinates</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">RM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">new_y</span> <span class="o">=</span> <span class="n">RM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">new_z</span> <span class="o">=</span> <span class="n">RM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

        <span class="n">new_vx</span><span class="o">=</span> <span class="n">RM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
        <span class="n">new_vy</span><span class="o">=</span> <span class="n">RM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
        <span class="n">new_vz</span><span class="o">=</span> <span class="n">RM</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">RM</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">part</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">modify</span><span class="p">:</span>
            <span class="n">part</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
            <span class="n">part</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
            <span class="n">part</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_z</span>
            <span class="n">part</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_vx</span>
            <span class="n">part</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_vy</span>
            <span class="n">part</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_vz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">,</span> <span class="n">new_z</span></div>

<div class="viewcode-block" id="Galaxy.cal_norm_vec"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_norm_vec">[docs]</a>    <span class="k">def</span> <span class="nf">cal_norm_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines normal vector of the given galaxy.</span>
<span class="sd">        &#39;galaxy&#39; means stellar particles by default. </span>
<span class="sd">        Add self.nvec attribute and also returns nvec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">if</span> <span class="n">part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
        <span class="n">vx</span><span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">]</span>
        <span class="n">vy</span><span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span>
        <span class="n">vz</span><span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span>

        <span class="n">lx</span><span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">vz</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">vy</span><span class="p">)</span> <span class="c1"># normalized; *m is omitted.</span>
        <span class="n">ly</span><span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">vx</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="n">vz</span><span class="p">)</span>
        <span class="n">lz</span><span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">vy</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">vx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lz</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ly</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">lz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvec</span></div>


    <span class="k">def</span> <span class="nf">_get_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the rotation matrix associated with counterclockwise rotation about</span>
<span class="sd">        the given axis by theta radians.</span>
<span class="sd">        http://stackoverflow.com/a/6802723</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">axis</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">*</span><span class="n">d</span>
        <span class="n">bc</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="n">d</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">aa</span><span class="o">+</span><span class="n">bb</span><span class="o">-</span><span class="n">cc</span><span class="o">-</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bc</span><span class="o">+</span><span class="n">ad</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bd</span><span class="o">-</span><span class="n">ac</span><span class="p">)],</span>
                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bc</span><span class="o">-</span><span class="n">ad</span><span class="p">),</span> <span class="n">aa</span><span class="o">+</span><span class="n">cc</span><span class="o">-</span><span class="n">bb</span><span class="o">-</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">cd</span><span class="o">+</span><span class="n">ab</span><span class="p">)],</span>
                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">bd</span><span class="o">+</span><span class="n">ac</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">cd</span><span class="o">-</span><span class="n">ab</span><span class="p">),</span> <span class="n">aa</span><span class="o">+</span><span class="n">dd</span><span class="o">-</span><span class="n">bb</span><span class="o">-</span><span class="n">cc</span><span class="p">]])</span>


<div class="viewcode-block" id="Galaxy.cal_rotation_matrix"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_rotation_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">cal_rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine Rotation Matrix by axis-angle rotation.</span>
<span class="sd">        </span>
<span class="sd">        parameters</span>
<span class="sd">        -------------</span>
<span class="sd">        nvec : normal vector. </span>
<span class="sd">            If not given, automatically calculated.</span>
<span class="sd">        dest : destination vector ( not axis of rotation!).</span>
<span class="sd">               +z direction ([0, 0, 1]) by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">lag</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="c1"># rotation axis</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="c1"># towards +z direction.</span>
        <span class="k">if</span> <span class="n">nvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvec</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">nvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_norm_vec</span><span class="p">()</span> <span class="c1"># Calculate, add, and return .nvec attribute.</span>

        <span class="k">if</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">nvec</span> <span class="o">=</span> <span class="n">nvec</span> <span class="o">/</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">/</span> <span class="n">lag</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="n">r_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

        <span class="n">RM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rotation_matrix</span><span class="p">(</span><span class="n">r_axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_matrix</span> <span class="o">=</span> <span class="n">RM</span>
        <span class="k">return</span> <span class="n">RM</span></div>
        
<div class="viewcode-block" id="Galaxy.bound_particles"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.bound_particles">[docs]</a>    <span class="k">def</span> <span class="nf">bound_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns indices of bound particles. </span>
<span class="sd">        By default for stellar particles.</span>
<span class="sd">        &quot;&quot;&quot;</span>       </div>
    
<div class="viewcode-block" id="Galaxy.cal_b2t"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_b2t">[docs]</a>    <span class="k">def</span> <span class="nf">cal_b2t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reorient galaxy first. </span>
<span class="sd">        </span>
<span class="sd">        parameters</span>
<span class="sd">        ----------------------</span>
<span class="sd">        hist : </span>
<span class="sd">            if True, ellipticity histogram is returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="c1"># Radius</span>

        <span class="c1"># Calculating boundness requires total mass inside a radius.</span>
        <span class="c1"># -&gt; DM, Cell are also needed. </span>
        <span class="n">part</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptype</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

        <span class="n">m_all_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> 
                              <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">],</span> 
                              <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;var0&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">unit_d</span>
                              <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">unit_l</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mf">1.98e33</span><span class="p">))</span>

        <span class="n">rstar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">r_all_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">rstar</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> 
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

        <span class="n">ind_r_all_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">r_all_arr</span><span class="p">)</span>
        <span class="n">m_all_radial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">m_all_arr</span><span class="p">[</span><span class="n">ind_r_all_sort</span><span class="p">])</span>
        
        <span class="c1"># enclosed mass at the location of each star particle.</span>
        <span class="n">enclosed_mass_at_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rstar</span><span class="p">,</span> <span class="n">r_all_arr</span><span class="p">[</span><span class="n">ind_r_all_sort</span><span class="p">],</span> <span class="n">m_all_radial</span><span class="p">)</span>
        
        <span class="n">boxtokpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mf">6.67384e-11</span>  <span class="c1"># m^3 kg^-1 s^-2</span>
        <span class="n">kpc_to_m</span> <span class="o">=</span> <span class="mf">3.08567758e19</span> 
        <span class="n">msun</span> <span class="o">=</span> <span class="mf">1.9891e30</span> <span class="c1"># kg</span>
        <span class="n">v_circ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G</span> <span class="o">*</span> <span class="n">msun</span> <span class="o">*</span> <span class="n">enclosed_mass_at_r</span> 
                        <span class="o">/</span><span class="p">(</span><span class="n">kpc_to_m</span> <span class="o">*</span> <span class="n">rstar</span> <span class="o">*</span> <span class="n">boxtokpc</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span> <span class="c1"># m/s to in km/s</span>

        <span class="n">j_circ</span> <span class="o">=</span> <span class="n">rstar</span> <span class="o">*</span> <span class="n">v_circ</span> <span class="c1"># * boxtokpc omitted (later compensated.)</span>
        <span class="c1"># Finally, r in code unit, v in km/s</span>

        <span class="n">j_phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">])</span> <span class="c1"># * boxtokpc omitted.</span>
        <span class="n">ellipticity</span> <span class="o">=</span> <span class="n">j_phi</span> <span class="o">/</span> <span class="n">j_circ</span>
                   
        <span class="c1"># &lt; 0.8 from Scannapieco 2009</span>
        <span class="n">disk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ellipticity</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d2t</span> <span class="o">=</span> <span class="n">disk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mstar</span> <span class="c1"># or sum(self.star[&#39;m&#39;][ind])</span>
        <span class="k">if</span> <span class="n">hist</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">ellipticity</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span></div>


<div class="viewcode-block" id="Galaxy.cal_trivia"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.cal_trivia">[docs]</a>    <span class="k">def</span> <span class="nf">cal_trivia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vcen</span><span class="p">()</span></div>
<span class="c1">#        self.metal = </span>
<span class="c1">#        self.reff = 12333</span>

<div class="viewcode-block" id="Galaxy.save_gal_pickle"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.save_gal_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">save_gal_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;gal.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>
         
<div class="viewcode-block" id="Galaxy.plot_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.plot_gal">[docs]</a>    <span class="k">def</span> <span class="nf">plot_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">wdir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">ticker</span>
        <span class="kn">from</span> <span class="nn">draw</span> <span class="k">import</span> <span class="n">pp</span>
        <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LogNorm</span>
<span class="c1">#        import utils.prettyplot as ptt</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        
        <span class="k">def</span> <span class="nf">fmt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">r&#39;$</span><span class="si">{}</span><span class="s1"> \times 10^{{</span><span class="si">{}</span><span class="s1">}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">do9plots</span> <span class="o">=</span> <span class="kc">False</span>        
        <span class="k">if</span> <span class="n">do9plots</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># 9 plots</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;ID: </span><span class="si">{}</span><span class="s2">    z: </span><span class="si">{:2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">zred</span><span class="p">))</span>

<span class="c1"># Stellar particle density map</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rgal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rscale_lambda</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">part2den</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="n">npix</span><span class="p">)</span>
<span class="c1">#        region=self.region, offset=[self.xc, self.yc, self.zc])</span>
<span class="c1">#        print(&quot;img max:&quot;, max(img.data))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">),</span>
                       <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="n">e6</span><span class="p">))</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;position [&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;-4&quot;</span><span class="p">,</span> <span class="s2">&quot;-2&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;position [kpc]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> \
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">rgal</span><span class="p">,</span> <span class="n">rgal</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>

<span class="c1"># Lambda_r plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">)</span> <span class="c1"># ~ 1 * Reff</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;$\lambda _</span><span class="si">{R}</span><span class="s2">$&quot;</span><span class="p">)</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">),</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mstar</span><span class="p">)</span> <span class="o">+</span> <span class="s2">r&quot;$M_{\odot}$&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_arr</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">])</span>


        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        im = ax.imshow(self.mmap, cmap=plt.get_cmap(&#39;brg&#39;),</span>
<span class="sd">                       norm=LogNorm(vmin=1e6))</span>

<span class="sd">        ax.set_xlabel(&quot;[&quot;+ r&#39;$R/R_{eff}$&#39;+&quot;]&quot;)</span>
<span class="sd">        ax.set_xticks(np.linspace(0, len(self.mmap), num=3))</span>
<span class="sd">        ax.set_xticklabels([&quot;-1.5&quot;, &quot;0&quot;, &quot;1.5&quot;])</span>
<span class="sd">        ax.set_ylabel(&quot;[kpc]&quot;)</span>
<span class="sd">        ax.set_yticks(np.linspace(0, len(self.mmap), num=5))</span>
<span class="sd">        yticks = [&quot;{:.2f}&quot;.format(y * self.info.pboxsize * 1000) \</span>
<span class="sd">                    for y in np.linspace(-self.reff, self.reff, num=5)]</span>
<span class="sd">        ax.set_yticklabels(yticks)        </span>

<span class="sd">        cb = plt.colorbar(im,</span>
<span class="sd">                          ax=ax,</span>
<span class="sd">#                          format=ticker.FuncFormatter(fmt),</span>
<span class="sd">                          label=r&quot;$M_{\odot} kpc^{-2}$&quot;)</span>
<span class="sd">#        tick_locator = ticker.MaxNLocator(nbins=3)</span>
<span class="sd">#        cb.locator = tick_locator</span>
<span class="sd">#        cb.update_ticks()</span>
<span class="sd">        ax.set_title(&quot;Stellar density map&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
<span class="c1"># sigma map</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;sigmap&quot;</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>        
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;brg&#39;</span><span class="p">))</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$km s^{-1}$&#39;</span><span class="p">)</span> <span class="c1"># needs a mappable object.</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">r&quot;$\sigma$ map&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[kpc]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">reff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reff</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>        
<span class="c1">#        ax.locator_params(tight=True, nbins=5)</span>

<span class="c1"># velocity map</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>
    <span class="c1">#        ax.tick_params(</span>
    <span class="c1">#            which=&#39;both&#39;,      # both major and minor ticks are affected</span>
    <span class="c1">#            bottom=&#39;off&#39;,      # ticks along the bottom edge are off</span>
    <span class="c1">#            top=&#39;off&#39;,         # ticks along the top edge are off</span>
    <span class="c1">#            labelbottom=&#39;off&#39;)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$km s^{-1}$&#39;</span><span class="p">)</span> <span class="c1"># needs a mappable object.</span>
            <span class="n">tick_locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick_locator</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;velocity map&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span> <span class="s1">r&#39;$R/R_</span><span class="si">{eff}</span><span class="s1">$&#39;</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">),</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[kpc]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmap</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">pboxsize</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">reff</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">reff</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rscale_lambda</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>        
              
<span class="c1">#        ax.locator_params(tight=True, nbins=5)</span>

        <span class="k">if</span> <span class="n">do9plots</span><span class="p">:</span>
    <span class="c1"># position and velocity histograms</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>        
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;X pos&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Y pos&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;X vel&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Y vel&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>        
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;galaxy_plot&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">wdir</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        
        
<div class="viewcode-block" id="Galaxy.save_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.save_gal">[docs]</a>    <span class="k">def</span> <span class="nf">save_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">hdf</span>
        <span class="c1"># Save data into a hdf5 file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;gal.hdf5&#39;</span>
        
        <span class="c1"># Create and open the file with the given name</span>
        <span class="k">with</span> <span class="n">hdf</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        
        <span class="c1"># Make a data set called galaxy</span>
<span class="c1">#        outfile.create_dataset(&quot;galaxy&quot;)</span>
        
        <span class="c1"># Create a group for stroing data</span>
            <span class="n">grp_gal</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;galaxy&quot;</span><span class="p">)</span>
    
            <span class="c1"># Store data under /galaxy with direct assignment        </span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/y&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/z&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/m&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/vx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/vy&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">])</span>
            <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/vz&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pq</span><span class="p">:</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/time&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;metal&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pq</span><span class="p">:</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;star/metal&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;metal&#39;</span><span class="p">])</span>        
            
            <span class="k">if</span> <span class="s2">&quot;dm&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pq</span><span class="p">:</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/y&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/z&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/m&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/vx&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/vy&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vy&#39;</span><span class="p">])</span>
                <span class="n">grp_gal</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;dm/vz&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">[</span><span class="s1">&#39;vz&#39;</span><span class="p">])</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/x&quot;, data=self.cell[&#39;x&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/y&quot;, data=self.cell[&#39;y&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/z&quot;, data=self.cell[&#39;z&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/vx&quot;, data=self.cell[&#39;var1&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/vy&quot;, data=self.cell[&#39;var2&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/vz&quot;, data=self.cell[&#39;var3&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/rho&quot;, data=self.cell[&#39;var0&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/temp&quot;, data=self.cell[&#39;var4&#39;])</span>
<span class="sd">        grp_gal.create_dataset(&quot;cell/metal&quot;, data=self.cell[&#39;var5&#39;])</span>
<span class="sd">        # Check the units, especially for temperature and metallicity</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        
<div class="viewcode-block" id="Galaxy.load_gal"><a class="viewcode-back" href="../../galaxy.html#galaxy.galaxy_mp.Galaxy.load_gal">[docs]</a>    <span class="k">def</span> <span class="nf">load_gal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a galaxy from HDF5 file. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>
<span class="c1">#%%        </span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyclusterevol -0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Hoseung.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>